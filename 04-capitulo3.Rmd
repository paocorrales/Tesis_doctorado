# Asimilacion de observaciones del satélite geoestacionario GOES-16

En este capítulo se evaluará el impacto que genera la asimilación de observaciones del sensor ABI a bordo del satélite GOES-16 tanto en el análisis como en pronósticos determinísticos de alta resolución para el caso de estudio del 22 de noviembre de 2018. Estas observaciones son de particular interés en la región de Sudamérica por su alta resolución espacial y frecuencia temporal. Las observaciones de los canales sensibles al vapor de agua, brindan además, información en 3 niveles de la atmósfera, algo que no era posible con los sensores previos a bordo de los satélites GOES. Esperamos que todo esto ayude a mejorar la representación de los procesos convectivos y de mesoescala en pronósticos a corto plazo. 

Por ser un satélite y sensor nuevos, la última versión de GSI (V3.7) que fue publicada en julio de 2018 no incluye la posibilidad de asimilar estas observaciones. Fue necesario, entonces, modificar el código fuente del sistema de asimilación para incluir las rutinas necesarias utilizando como base los trabajos previos de @lee2019 y @liu2019. También por esta razón, el capítulo incluirá el análisis de experimentos para definir la mejor configuración posible y evaluar la técnicamente la asimilación de observaciones de ABI.

## Metodología

### Asimilación de observaciones de goes {#asim-goes}

La asimilación directa de radianzas de ABI requiere las mismas consideraciones descriptas previamente en la sección \@ref(asim-rad) en cuanto a control de calidad, corrección de bias, thnning e indentificación de pixeles nubosos. En esta sección se describiran las deciciones metodológicas y técnicas que se tomaron a la hora de asimilar las observaciones, en base a las pruebas preliminares realizadas. 

Si bien las radianzas de satélite pueden tener errores sistemáticos asociados a las condiciones de la atmósfera, la geometría de observación y condiciones específicas de los sensores que deben ser corregidos previo a la asimilación, para este trabajo se generó una primera prueba de asimilación para evaluar la magnitud de estos errores. Esta primera prueba utiliza la misma configuración de modelo y ensamble que los experimentos discutidos previamente e incluye la asimilación de los 3 canales de ABI en conjunto.

La Figura \@ref(fig:oma-dist) muestra la distribución de la diferencia entre las observaciones y el campo preliminar (OmF) y entre las observaciones y el análisis (OmA) para todo el periodo. Si las observaciones no tienen bias la distribución OmF estará centrada en cero. En este caso solo el canal 9 presenta un bias positivo muy pequeño del orden de 0.3 K (Tabla \@ref(tab:oma-tabla)). Por esta razón no se hará corrección del bias de estas observaciones. 

La Figura \@ref(fig:oma-dist) y la Tabla \@ref(tab:oma-tabla) muestran además otro resultado importante. Si la asimilación de las observaciones se realizó correctamente es esperable que la diferencia OmA esté más cerca de cero que OmF y que su distribución tenga menos varianza. Esto se observa para los 3 canales asimilados y confirma que la implementación técnica dentro del sistema funciona correctamente. Notar que los cambios abruptos y simétricos en las curvas de distribución se deben al chequeo preliminar que se realiza como parte de los controles de calidad y que elimina aquellas observaciones que tienen un diferencia mayor a 2.2 K con respecto del campo preliminar. 

```{r eval=FALSE, include=FALSE}
files <- Sys.glob("/home/paola.corrales/datosmunin3/EXP/EG3/ANA/*/diagfiles/asim_abi*ensmean")

files <- files[!str_detect(files, "conv")]

abi <- map(files, function(f) {
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin3/EXP/{exp}/ANA/{date}/diagfiles/asim_abi_g16_{date}.ensmean")
  
  read_diag_rad(f, meta[[1]][["exp"]]) %>% 
    .[, channel := channel + 6] %>% 
    satinfo[., on = c("sensor", "channel")] 
  # %>% 
  #   .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
  #            lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))]
  # 
  
}) %>% rbindlist()

abi[channel %in% c(8:10), .(mean_ob = mean(tbc),
                            sd_ob = sd(tbc)), by = .(channel, exp, date)] %>% 
  melt(id.vars = c("channel", "date", "exp")) %>% 
  .[, channel := factor(channel)] %>% 
  ggplot(aes(date, value)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  # geom_point(aes(color = channel, shape = variable)) +
  geom_line(aes(color = channel, linetype = variable)) +
  scale_color_manual(values = c("darkorange", "cyan4", "purple")) +
  facet_wrap(~exp) +
  labs(x = NULL, y = "mean/sd [K]") +
  theme_minimal()


abi[channel %in% c(8:10), .(mean_ob = mean(tbc),
                            sd_ob = sd(tbc)), by = .(channel, exp)] %>% 
```

(ref:oma-dist) Distribución de la diferencia entre las observaciones y el campo preliminar (OmF) y la observacion y el análisis (OmA) para los 3 canales de ABI y a lo largo de todo el periodo de prueba. 

```{r oma-dist, fig.cap="(ref:oma-dist)", fig.align='center'}
# path_data <- "/home/paola.corrales/datosmunin3/EXP/"
# 
# files_gue <- Sys.glob(paste0(path_data, "E10/ANA/*/diagfiles/asim_abi_g16_*.ensmean"))
# files_ana <- Sys.glob(paste0(path_data, "E10/ANA/*/diagfiles_ana/asim_abi_g16_*.ensmean"))
# 
# d <- map2(files_gue, files_ana, function(fg, fa) {
#   
#   meta <- unglue::unglue(fg, "/home/paola.corrales/datosmunin3/EXP/E10/ANA/{date}/diagfiles/asim_abi_g16_{date2}.ensmean")
#   gue <- read_diag_rad(fg, "E10") %>% 
#     .[, channel := channel + 6] %>% 
#     .[channel %in% c(8:10) & qc == 0, .(channel, lat, lon, tb_obs, tbc)] %>% 
#     .[, run := "guess"]
#   
#   ana <- read_diag_rad(fa, "E10") %>% 
#     .[, channel := channel + 6] %>% 
#     .[channel %in% c(8:10) & qc == 0, .(channel, lat, lon, tb_obs, tbc)] %>% 
#     .[, run := "ana"]
#   
#   rbind(ana, gue) %>% 
#     .[, fecha := meta[[1]][["date"]]] %>% 
#     # .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
#              # lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))] %>% 
#     .[]
#   
# }) %>% 
#   rbindlist()
# write_csv(d, here("data/derived_data/sample_obs/E10_omb_oma.csv"))

diag_E10 <- fread(here("data/derived_data/sample_obs/E10_omb_oma.csv"))

diag_E10 %>% 
  ggplot(aes(tbc)) +
  geom_density(aes(color = run), key_glyph = draw_key_path) +
  scale_x_continuous(limits = c(-5, 5)) +
  scale_color_manual(values = c("#1f78b4", "#33a02c"), labels = c("OmA", "OmF")) +
  labs(x = "OmF / OmA (K)",
       y = "Densidad de probabilidad", 
       color = NULL) +
  facet_wrap(~channel, labeller = labeller(channel = c("8" = "Canal 8",
                                            "9" = "Canal 9",
                                            "10" = "Canal 10"))) +
  tagger::tag_facets() +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

```{r oma-tabla}
diag_E10[, .(rms = mean(tbc)), by = .(channel, run)] %>% 
  dcast(run ~ channel) %>% 
  .[, run := c("OmA", "OmF")] %>% 
  arrange(desc(run)) %>% 
   kbl(booktabs = TRUE, col.names = c("", "Canal 8", "Canal 9", "Canal 10"),
       digits = 4, 
      align = "lrrr",
      caption = "Observación menos análisis o campo preliminar medio calculado sobre todo el periodo.") %>% 
  kable_classic_2(full_width = TRUE) 
```

La asimilación de radianzas en *all sky*, es decir tanto para cielos claros como nubosos es todavía un importante desafío ya que estos dos tipos de observaciones requieren un control de calidad y estimaciones de errores específicos. En esta primera aproximación a la asimilación de observaciones de ABI solo se utilizaron observaciones en cielo claro. Para detectar y filtrar los pixeles nubosos utilizamos la mascara de nubes ACM (por ABI Cloud Mask) disponible con la misma frecuencia que las observaciones. Esta mascara de nubes da información binaria (cielo claro o cielo nuboso) y tienen una exactitud del 87%. La estimación es realizada utilizando información de 10 canales de ABI e incluye pruebas espectrales, espaciales y temporales. En las Figuras \@ref(fig:cld-msk) se presentan 2 ejemplos de máscara de nubes a las 00 UTC del 20 de noviembre y a las 18 UTC del 22 de noviembre. 

(ref:cld-msk) Ubicación de píxeles nubosos (gris) según la máscara de nubes generada como producto de nivel 2 para GOES-16, durante el a) 06 UTC del 20 de noviembre y b) 18 UTC del 22 de noviembre. 

```{r cld-msk, fig.cap="(ref:cld-msk)", fig.width=6, fig.height=3}
#dominio de interés
xlim <- c(2600, 3950)
ylim <- c(3700, 4750)

files_acm <- c('~/datosmunin3/DATA/GOES16/ABI-L2-ACMF/OR_ABI-L2-ACMF-M3_G16_s20183240000342_e20183240011109_c20183240011270.nc', 
               '~/datosmunin3/DATA/GOES16/ABI-L2-ACMF/OR_ABI-L2-ACMF-M3_G16_s20183261800364_e20183261811131_c20183261811304.nc')



cld_msk <- map(files_acm, function(f){
  
  nc <- ncdf4::nc_open(f)
  
  ReadNetCDF(f, vars = c('BCM', 't'), 
             subset = list(x = xlim,  y = ylim)) %>% 
    .[, t := as_datetime(t, origin = "2000-01-01 12:00:00", tz = "UTC")] %>% 
    .[, c("lon", "lat") := goes_projection(x, y, nc)]
  
}) %>% 
  rbindlist()


cld_msk %>% 
  .[, t := factor(t)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = factor(BCM))) +
  scale_color_manual(values = c("white", "darkgrey"), guide = NULL) +
  geom_mapa() +
  facet_wrap(~t, labeller = labeller(t = c("2018-11-20 00:05:52" = "6 UTC, 20 de Nov",
                                           "2018-11-22 18:05:54" = "18 UTC, 22 de Nov"))) +
  tagger::tag_facets() +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 9)

```
Debido al desarrollo de actividad convectiva en el dominio durante el periodo simulado, la cantidad de observaciones en cielo claro varía considerablemente. Esto puede apreciarse en las Figuras \@ref(fig:cld-msk) a y b. Sin embargo la cantidad de observaciones que aporta ABI es casi siempre superior a las observaciones de satélites polares (Figura \@ref(fig:obs-rad)) . 

(ref:obs-rad) a) Número de observaciones asimiladas en cada ciclo y b) número medio de observaciones asimiladas por ciclo en capas verticales de 50 hPa de espesor para los experimentos RAD (circulos rojos) y ABI (cuadrados turquezas).

```{r obs-rad, fig.cap="(ref:obs-rad)", fig.height=3.5, fig.width=6}

files <- Sys.glob(here("~/datosmunin3/EXP/E10/ANA/*/diagfiles/asim*ensmean"))

files <- files[!str_detect(files, "conv")]

rad <- map(files, function(f){ 
  
  rad <- read_diag_rad(f, "E10") %>% 
    satinfo[., on = c("sensor", "channel")] 
  
  rad <- rad[, .(sensor, press, iuse, error, exp, date)] %>% 
    setnames(c("press", "iuse", "error"), c("pressure", "usage.flag", "rerr"))
  
  rad_date <- rad %>% 
    rbind(., rad) %>% 
    .[usage.flag >= 1 & rerr != 1.0e+10] %>% 
    .[, .(count_obs = .N), by = .(sensor, exp, date)] 
  
  rad_lev <- rad %>% 
    .[usage.flag >= 1 & rerr != 1.0e+10] %>% 
    .[, ":="(lev.box = cut_round(pressure, breaks = seq(0, 1150, 50)))] %>% 
    .[, .(count_obs = .N), by = .(sensor, exp, lev.box, date)]
  list(rad_date = rad_date, rad_lev = rad_lev)
  
}) %>% 
  reduce(function(x, y) list(rad_date = rbind(x$rad_date, y$rad_date),
                             rad_lev = rbind(x$rad_lev, y$rad_lev)))


rad$rad_date %>% 
  .[, exp := fifelse(str_detect(sensor, "abi"), "ABI", "RAD")] %>% 
  .[, .(count_obs = sum(count_obs)), by = .(exp, date)] %>%
  ggplot(aes(date, count_obs)) +
  geom_line(aes(color = exp), size = 0.2) +
  geom_point(aes(color = exp, shape = exp), size = 1) +
  scale_color_manual(values = c("#047994", "#CC3311")) +
  scale_shape_manual(values = c(15, 16)) +
  scale_y_log10() +
  scale_date() +
  labs(y = "Número de obs por ciclo", x = "Hora (UTC)",
       color = NULL, shape = NULL) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom", 
        panel.background = element_rect(fill = "#fbfbfb", color = NA),
        plot.margin = unit(c(0, 0, 0, 0), "cm")) +
  
  rad$rad_lev %>% 
  .[, exp := fifelse(str_detect(sensor, "abi"), "ABI", "RAD")] %>% 
  # .[, ":="(lev.box = cut_round(pressure, breaks = seq(50, 1050, 50)))] %>% 
  # .[, .(count_obs = .N), by = .(exp, lev.box, date)] %>% 
  .[, .(obs_cycle = mean(count_obs, na.rm = TRUE)), by = .(exp, lev.box)] %>% 
  ggplot(aes(lev.box, obs_cycle)) +
  geom_line(aes(color = exp), size = 0.2) +
  geom_point(aes(color = exp, shape = exp), size = 1) +
  scale_color_manual(values = c("#047994", "#CC3311")) +
  scale_shape_manual(values = c(15, 16)) +
  scale_y_log10() +
  scale_x_reverse() +
  coord_flip() +
  labs(color = NULL, shape = NULL,
       x = "Nivel de presión (hPa)", y = "Cantidad media de \nobs por ciclo") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom",
        plot.margin = unit(c(0, 0, 0, 0), "cm")) +
  
  plot_layout(ncol = 2, widths = c(4, 1), guides = "collect") + 
  plot_annotation(tag_levels = 'a', tag_suffix = ")") &
  theme(plot.tag = element_text(size = 8), 
        legend.position = "bottom",
        legend.spacing = unit(c(0, 0, 0, 0), "cm"),
        panel.background = element_rect(fill = "#fbfbfb", color = NA),
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

```

### Configuracion de los experimentos

En este capítulo se analizan una serie de experimentos, primero para evaluar la sensibilidad a distintas combinaciones de canales y a la resolución del thinning y finalmente para comparar el impacto de la asimilación de observaciones de ABI en conjunto o no de satélites polares. Los experimentos SATWND y RAD fueron analizados previamente en el capítulo \@ref(ch1). SATWND asimila observaciones de EMC, EMA y vientos deriados de satélite y RAD suma a lo anterior radianzas en aire claro de sensores a bordo de satélites polares. RAD+ABI incluye además observaciones de los 3 canales de vapor de agua de ABI con un thinning de 10 km. Finalmente el conjunto de experimentos ABI incluye radianzas de ABI pero no de satélites polares, y usan distintas combinaciones de canales y resolución de thinning (Tabla \@ref(tab:exp-rad)). 


```{r exp-rad}
tribble(
  ~exp, ~obs, ~canales, ~thinning,
  "SATWND", "--", "--", "--", 
  "RAD", "Radianzas de satélites polares", "--", "--",
  "RAD+ABI", "Radianzas de satélites polares y ABI", "8, 9, 10 ", "10 km ", 
  "ABI_ch890_th10", "Radianzas de ABI", "8, 9, 10 ", "10 km ", 
  "ABI_ch890_th30", "Radianzas de ABI", "8, 9, 10 ", "30 km ",
  "ABI_ch90_th30", "Radianzas de ABI", "9, 10 ", "30 km ",
  "ABI_ch0_th30", "Radianzas de ABI", "10 ", "30 km ",
) %>% 
  kbl(booktabs = TRUE, col.names = c("Experimento", "Radianzas asimiladas", "Canales ABI", "Thining ABI"),
      align = "llcc",
      caption = "Experimentos realizados. Todos los experimentos incluyen observaciones de EMC, EMA y vientos derivados de satélite. ") %>% 
  kable_classic_2(full_width = TRUE) %>% 
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "20em") %>%
#   column_spec(2:3, width = "2.5em", latex_valign = "m") %>% 
  column_spec(3:4, width = "4em", latex_valign = "m")

```

Todos los experimentos previamente descriptos usan la configuración del ensamble multifísica y del sistema de asimilación explicada en la sección \@ref(configmodelo). La misma manera el análisis horario se realiza desde las 18 UTC del 20 de noviembre hasta las 12 UTC del 23 de noviembre para cubrir el desarrollo y maduración del SCM. 

Para estudiar el impacto de la asimilación de radianzas también se generaron pronósticos determinísticos en alta resolución inicializados a las 00 y 06 UTC del 22 de noviembre (Figura \@ref(fig:cycle-fcst). En la Figura \@ref(fig:dominio-det) se muestra el dominio *d01* con 10 km de resolución (línea negra), identico al dominio utilizado para el resto de las simulaciones y el dominio anidado *d02* con 2 km de resolución (línea turquesa). Las condiciones iniciales están dadas por los análisis de los distintos experimentos y las condiciones de borde son generadas a partir del GFSF determinístico. Además las variables atmósfericas para el *d02* fueron inicializadas haciendo un escalado de la información del análisis. Todos los pronósticos utilizan las mismas parametrizaciones: del modelo de superficie terrestre (Noah-MP, @chen2001), de microfísica (esquema de un solo momento de 6 clases del WRF, @hong2006a) de procesos radiativos (esquema de onda corta y onda larga del RRTMG, @iacono2008), YSU [@hong2006] para capa límite y KF [@kain2004] para covección (solo aplicado al *d01*).

Además de los pronósticos inicializados a partir de los análisis, se generaron pronósticos inicializados a partir de GFS, es decir, sin asimilación de datos regional. Estos pronósticos tienen la misma configuración y usan el mismo conjunto de parametrizaciones que los los pronósticos descriptos previamente. 

(ref:dominio-det) Dominio de baja resolución (d01, 10 km) marcado con un recuadro negro y dominio anidado de alta resolución (d02, 2 km) marcado en color turquesa. 

```{r dominio-det, fig.cap="(ref:dominio-det)", fig.width=3, fig.height=3, fig.align="center"}
d02 <- ReadNetCDF("/home/paola.corrales/datosmunin3/EXP/E10/FCST/2018112200_det/wrfout_d02_2018-11-22_00:00:00", vars = c("XLAT", "XLONG")) %>% 
  setnames(c("XLAT", "XLONG"), c("lat", "lon"))

square_d02 <- d02 %>% 
  copy() %>% 
  .[, square1 := west_east %in% range(west_east) , by = .(south_north)] %>% 
  .[, square2 := south_north %in% range(south_north) , by = .(west_east)] %>% 
  .[square1 | square2] 


dominio <- fread(here("data/derived_data/sample_obs/dominio_hgt.csv")) %>% 
  .[, c("x", "y") := wrf_project(lon, lat)]

dominio %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = hgt), proj = norargentina_lambert,
                    breaks = seq(0, 6000, 500)) +
  scale_fill_gradient(low = "#f2f2f2", high = "#333333",
                      name = NULL,
                      breaks = seq(0, 6000, 1000),
                      guide = NULL) +
  geom_mapa() +
  geom_point(data = square, aes(lon, lat), size = 0.2) +
  geom_point(data = square_d02, aes(lon, lat), size = 0.2, color = "#047994") +
  annotate("text", x = -73.5, y = -40.5, color = "black", label = "d01", size = 3) +
  annotate("text", x = -66, y = -39.5, color = "#047994", label = "d02", size = 3) +
  theme_minimal(base_size = 10) +
  theme(legend.box = "horizontal",
        legend.position = c(0.1, 0.95),
        legend.background = element_rect(fill = "white", color = "white")) 

```


## Resultados

### Sensibilidad a la combinación de canales {#canales}

### Sensibilidad al thinning {#thinning}

### Comparación del impacto de GOES-16 versus satélites polares

#### Analisis

#### Pronósticos determinísticos

## Conclusiones

