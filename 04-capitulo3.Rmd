# Asimilacion de observaciones del satélite geoestacionario GOES-16

En este capítulo se evaluará el impacto que genera la asimilación de observaciones del sensor ABI a bordo del satélite GOES-16 tanto en el análisis como en pronósticos determinísticos de alta resolución para el caso de estudio del 22 de noviembre de 2018. Estas observaciones son de particular interés en la región de Sudamérica por su alta resolución espacial y frecuencia temporal. Las observaciones de los canales sensibles al vapor de agua, brindan además, información en 3 niveles de la atmósfera, algo que no era posible con los sensores previos a bordo de los satélites GOES. Esperamos que la asimilaci'on de estas observaciones contribuya a mejorar la representación de los procesos convectivos y de mesoescala en pronósticos a corto plazo. 

Por ser un satélite y sensor nuevos, la última versión de GSI (V3.7) que fue publicada en julio de 2018 no incluye la posibilidad de asimilar estas observaciones. Fue necesario, entonces, modificar el código fuente del sistema de asimilación para incluir las rutinas necesarias utilizando como base los trabajos previos de @lee2019 y @liu2019. También por esta razón, el capítulo incluirá el análisis de experimentos para definir la mejor configuración posible y evaluar técnicamente la asimilación de observaciones de ABI.

## Metodología

### Asimilación de observaciones de goes {#asim-goes}

La asimilación directa de radianzas de ABI requiere las mismas consideraciones descriptas previamente en la Sección \@ref(asim-rad) en cuanto a control de calidad, corrección de bias, thnning e indentificación de pixeles nubosos. En esta Sección se describiran las deciciones metodológicas y técnicas que se tomaron a la hora de asimilar las observaciones, en base a las pruebas preliminares realizadas. 

Si bien las radianzas de satélite pueden tener errores sistemáticos asociados a las condiciones de la atmósfera, la geometría de observación y condiciones específicas de los sensores que deben ser corregidos previo a la asimilación, para este trabajo se generó una primera prueba de asimilación para evaluar la magnitud de estos errores. Esta primera prueba utiliza la misma configuración de modelo y ensamble que los experimentos discutidos previamente e incluye la asimilación de los 3 canales de ABI en conjunto.

La Figura \@ref(fig:oma-dist) muestra la distribución de la diferencia entre las observaciones y el campo preliminar (OmF) y entre las observaciones y el análisis (OmA) para todo el periodo. Si las observaciones no tienen bias la distribución OmF estará centrada en cero. En este caso solo el canal 9 presenta un bias positivo muy pequeño del orden de 0.3 K (Tabla \@ref(tab:oma-tabla)). Por esta razón no se hará corrección del bias a estas observaciones. 

La Figura \@ref(fig:oma-dist) y la Tabla \@ref(tab:oma-tabla) muestran además otro resultado importante. Si la asimilación de las observaciones se realizó correctamente es esperable que la diferencia OmA esté más cerca de cero que OmF y que su distribución tenga menos varianza. Esto se observa para los 3 canales asimilados y confirma que la implementación técnica dentro del sistema funciona correctamente. Notar que los cambios abruptos y simétricos en las curvas de distribución se deben al chequeo preliminar que se realiza como parte de los controles de calidad y que elimina aquellas observaciones que tienen un diferencia mayor a 2.2 K con respecto del campo preliminar. 

```{r eval=FALSE, include=FALSE}
files <- Sys.glob(here("data/derived_data/omb_diagfiles/EG3/asim_abi*ensmean"))

files <- files[!str_detect(files, "conv")]

abi <- map(files, function(f) {
  
  meta <- unglue(f, "data/derived_data/omb_diagfiles/{exp}/asim_abi_g16_{date}.ensmean")
  
  read_diag_rad(f, meta[[1]][["exp"]]) %>% 
    .[, channel := channel + 6] %>% 
    satinfo[., on = c("sensor", "channel")] 
  # %>% 
  #   .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
  #            lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))]
  # 
  
}) %>% rbindlist()

abi[channel %in% c(8:10), .(mean_ob = mean(tbc),
                            sd_ob = sd(tbc)), by = .(channel, exp, date)] %>% 
  melt(id.vars = c("channel", "date", "exp")) %>% 
  .[, channel := factor(channel)] %>% 
  ggplot(aes(date, value)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  # geom_point(aes(color = channel, shape = variable)) +
  geom_line(aes(color = channel, linetype = variable)) +
  scale_color_manual(values = c("darkorange", "cyan4", "purple")) +
  facet_wrap(~exp) +
  labs(x = NULL, y = "mean/sd [K]") +
  theme_minimal()


abi[channel %in% c(8:10), .(mean_ob = mean(tbc),
                            sd_ob = sd(tbc)), by = .(channel, exp)] %>% 
```

(ref:oma-dist) Distribución de la diferencia entre las observaciones y el campo preliminar (OmF) y la observacion y el análisis (OmA) para los 3 canales de ABI y a lo largo de todo el periodo de prueba. 

```{r oma-dist, fig.cap="(ref:oma-dist)", fig.align='center'}
# path_data <- "/home/paola.corrales/datosmunin3/EXP/"
# 
# files_gue <- Sys.glob(paste0(path_data, "E10/ANA/*/diagfiles/asim_abi_g16_*.ensmean"))
# files_ana <- Sys.glob(paste0(path_data, "E10/ANA/*/diagfiles_ana/asim_abi_g16_*.ensmean"))
# 
# d <- map2(files_gue, files_ana, function(fg, fa) {
#   
#   meta <- unglue::unglue(fg, "/home/paola.corrales/datosmunin3/EXP/E10/ANA/{date}/diagfiles/asim_abi_g16_{date2}.ensmean")
#   gue <- read_diag_rad(fg, "E10") %>% 
#     .[, channel := channel + 6] %>% 
#     .[channel %in% c(8:10) & qc == 0, .(channel, lat, lon, tb_obs, tbc)] %>% 
#     .[, run := "guess"]
#   
#   ana <- read_diag_rad(fa, "E10") %>% 
#     .[, channel := channel + 6] %>% 
#     .[channel %in% c(8:10) & qc == 0, .(channel, lat, lon, tb_obs, tbc)] %>% 
#     .[, run := "ana"]
#   
#   rbind(ana, gue) %>% 
#     .[, fecha := meta[[1]][["date"]]] %>% 
#     # .[, ":="(lon.box = cut_round(lon, breaks = seq(284, 309, 2.5)),
#              # lat.box = cut_round(lat, breaks = seq(-42, -17, 2.5)))] %>% 
#     .[]
#   
# }) %>% 
#   rbindlist()
# write_csv(d, here("data/derived_data/sample_obs/E10_omb_oma.csv"))

diag_E10 <- fread(here("data/derived_data/sample_obs/E10_omb_oma.csv"))

diag_E10 %>% 
  ggplot(aes(tbc)) +
  geom_density(aes(color = run), key_glyph = draw_key_path) +
  scale_x_continuous(limits = c(-5, 5)) +
  scale_color_manual(values = c("#1f78b4", "#33a02c"), labels = c("OmA", "OmF")) +
  labs(x = "OmF / OmA (K)",
       y = "Densidad de probabilidad", 
       color = NULL) +
  facet_wrap(~channel, labeller = labeller(channel = c("8" = "Canal 8",
                                                       "9" = "Canal 9",
                                                       "10" = "Canal 10"))) +
  tagger::tag_facets() +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

```{r oma-tabla}
diag_E10[, .(rms = mean(tbc)), by = .(channel, run)] %>% 
  dcast(run ~ channel) %>% 
  .[, run := c("OmA", "OmF")] %>% 
  arrange(desc(run)) %>% 
  kbl(booktabs = TRUE, col.names = c("", "Canal 8", "Canal 9", "Canal 10"),
      digits = 4, 
      align = "lrrr",
      caption = "Observación menos análisis o campo preliminar medio calculado sobre todo el periodo.") %>% 
  kable_classic_2(full_width = TRUE) 
```

La asimilación de radianzas en *all sky*, es decir tanto para cielos claros como nubosos es todavía un importante desafío ya que estos dos tipos de observaciones requieren un control de calidad y estimaciones de errores específicos. En esta primera aproximación a la asimilación de observaciones de ABI solo se utilizaron observaciones en cielo claro. Para detectar y filtrar los pixeles nubosos utilizamos la mascara de nubes ACM (por ABI Cloud Mask) disponible con la misma frecuencia que las observaciones. Esta mascara de nubes da información binaria (cielo claro o cielo nuboso) y tienen una exactitud del 87%. La estimación es realizada utilizando información de 10 canales de ABI e incluye pruebas espectrales, espaciales y temporales. En las Figuras \@ref(fig:cld-msk) se presentan 2 ejemplos de máscara de nubes a las 00 UTC del 20 de noviembre y a las 18 UTC del 22 de noviembre. 

(ref:cld-msk) Ubicación de píxeles nubosos (gris) según la máscara de nubes generada como producto de nivel 2 para GOES-16, durante el a) 06 UTC del 20 de noviembre y b) 18 UTC del 22 de noviembre. 

```{r cld-msk, fig.cap="(ref:cld-msk)", fig.width=6, fig.height=3}
#dominio de interés
xlim <- c(2600, 3950)
ylim <- c(3700, 4750)

files_acm <- Sys.glob(here("data/derived_data/observations/OR_ABI-L2-ACMF-M3_G16_*"))


cld_msk <- map(files_acm, function(f){
  
  nc <- ncdf4::nc_open(f)
  
  ReadNetCDF(f, vars = c('BCM', 't'), 
             subset = list(x = xlim,  y = ylim)) %>% 
    .[, t := as_datetime(t, origin = "2000-01-01 12:00:00", tz = "UTC")] %>% 
    .[, c("lon", "lat") := goes_projection(x, y, nc)]
  
}) %>% 
  rbindlist()


cld_msk %>% 
  .[, t := factor(t)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = factor(BCM))) +
  scale_color_manual(values = c("white", "darkgrey"), guide = NULL) +
  geom_mapa() +
  facet_wrap(~t, labeller = labeller(t = c("2018-11-20 00:05:52" = "6 UTC, 20 de Nov",
                                           "2018-11-22 18:05:54" = "18 UTC, 22 de Nov"))) +
  tagger::tag_facets() +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 9)

```
Debido al desarrollo de actividad convectiva en el dominio durante el periodo simulado, la cantidad de observaciones en cielo claro varía considerablemente. Esto puede apreciarse en las Figuras \@ref(fig:cld-msk) a y b. Sin embargo la cantidad de observaciones que aporta ABI es casi siempre superior a las observaciones de satélites polares (Figura \@ref(fig:obs-rad)a) . 

(ref:obs-rad) a) Número de radianzas asimiladas en cada ciclo y b) número medio de radianzas asimiladas por ciclo en capas verticales de 50 hPa de espesor para los experimentos RAD (radianzas de satélites polares, circulos rojos) y ABI (radianzas de ABI, cuadrados turquezas).

```{r obs-rad, fig.cap="(ref:obs-rad)", fig.height=3.5, fig.width=6}

files <- Sys.glob(here("data/derived_data/omb_diagfiles/E10/asim*ensmean"))

files <- files[!str_detect(files, "conv")]

rad <- map(files, function(f){ 
  
  rad <- read_diag_rad(f, "E10") %>% 
    satinfo[., on = c("sensor", "channel")] 
  
  rad <- rad[, .(sensor, press, iuse, error, exp, date)] %>% 
    setnames(c("press", "iuse", "error"), c("pressure", "usage.flag", "rerr"))
  
  rad_date <- rad %>% 
    rbind(., rad) %>% 
    .[usage.flag >= 1 & rerr != 1.0e+10] %>% 
    .[, .(count_obs = .N), by = .(sensor, exp, date)] 
  
  rad_lev <- rad %>% 
    .[usage.flag >= 1 & rerr != 1.0e+10] %>% 
    .[, ":="(lev.box = cut_round(pressure, breaks = seq(0, 1150, 50)))] %>% 
    .[, .(count_obs = .N), by = .(sensor, exp, lev.box, date)]
  list(rad_date = rad_date, rad_lev = rad_lev)
  
}) %>% 
  reduce(function(x, y) list(rad_date = rbind(x$rad_date, y$rad_date),
                             rad_lev = rbind(x$rad_lev, y$rad_lev)))


rad$rad_date %>% 
  .[, exp := fifelse(str_detect(sensor, "abi"), "ABI", "RAD")] %>% 
  .[, .(count_obs = sum(count_obs)), by = .(exp, date)] %>%
  ggplot(aes(date, count_obs)) +
  geom_line(aes(color = exp), size = 0.2) +
  geom_point(aes(color = exp, shape = exp), size = 1) +
  scale_color_manual(values = c("#047994", "#CC3311")) +
  scale_shape_manual(values = c(15, 16)) +
  scale_y_log10() +
  scale_date() +
  labs(y = "Número de obs por ciclo", x = "Hora (UTC)",
       color = NULL, shape = NULL) +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom", 
        panel.background = element_rect(fill = "#fbfbfb", color = NA),
        plot.margin = unit(c(0, 0, 0, 0), "cm")) +
  
  rad$rad_lev %>% 
  .[, exp := fifelse(str_detect(sensor, "abi"), "ABI", "RAD")] %>% 
  # .[, ":="(lev.box = cut_round(pressure, breaks = seq(50, 1050, 50)))] %>% 
  # .[, .(count_obs = .N), by = .(exp, lev.box, date)] %>% 
  .[, .(obs_cycle = mean(count_obs, na.rm = TRUE)), by = .(exp, lev.box)] %>% 
  ggplot(aes(lev.box, obs_cycle)) +
  geom_line(aes(color = exp), size = 0.2) +
  geom_point(aes(color = exp, shape = exp), size = 1) +
  scale_color_manual(values = c("#047994", "#CC3311")) +
  scale_shape_manual(values = c(15, 16)) +
  scale_y_log10() +
  scale_x_reverse() +
  coord_flip() +
  labs(color = NULL, shape = NULL,
       x = "Nivel de presión (hPa)", y = "Cantidad media de \nobs por ciclo") +
  theme_minimal(base_size = 10) +
  theme(legend.position = "bottom",
        plot.margin = unit(c(0, 0, 0, 0), "cm")) +
  
  plot_layout(ncol = 2, widths = c(4, 1), guides = "collect") + 
  plot_annotation(tag_levels = 'a', tag_suffix = ")") &
  theme(plot.tag = element_text(size = 8), 
        legend.position = "bottom",
        legend.spacing = unit(c(0, 0, 0, 0), "cm"),
        panel.background = element_rect(fill = "#fbfbfb", color = NA),
        plot.margin = unit(c(0, 0, 0, 0), "cm"))

```

### Configuracion de los experimentos

En este capítulo se analizan una serie de experimentos, primero para evaluar la sensibilidad a distintas combinaciones de canales y a la resolución del thinning y finalmente para comparar el impacto de la asimilación de observaciones de ABI en conjunto o no con observaciones de satélites polares. Los experimentos SATWND y RAD fueron analizados previamente en el capítulo \@ref(ch1). SATWND asimila observaciones de EMC, EMA y vientos deriados de satélite y RAD suma a lo anterior radianzas en aire claro de sensores a bordo de satélites polares. RAD+ABI incluye además observaciones de los 3 canales de vapor de agua de ABI con un thinning de 10 km. Finalmente el conjunto de experimentos ABI incluye radianzas de ABI pero no de satélites polares, y usan distintas combinaciones de canales y resolución de thinning (Tabla \@ref(tab:exp-rad)). 


```{r exp-rad}
tribble(
  ~exp, ~obs, ~canales, ~thinning,
  "SATWND", "--", "--", "--", 
  "RAD", "Radianzas de satélites polares", "--", "--",
  "RAD+ABI", "Radianzas de satélites polares y ABI", "8, 9, 10 ", "10 km ", 
  "ABI_ch890_th10 (ABI)", "Radianzas de ABI", "8, 9, 10 ", "10 km ", 
  "ABI_ch890_th30", "Radianzas de ABI", "8, 9, 10 ", "30 km ",
  "ABI_ch90_th30", "Radianzas de ABI", "9, 10 ", "30 km ",
  "ABI_ch0_th30", "Radianzas de ABI", "10 ", "30 km ",
) %>% 
  kbl(booktabs = TRUE, col.names = c("Experimento", "Radianzas asimiladas", "Canales ABI", "Thining ABI"),
      align = "llcc",
      caption = "Experimentos realizados. Todos los experimentos incluyen observaciones de EMC, EMA y vientos derivados de satélite. ") %>% 
  kable_classic_2(full_width = TRUE) %>% 
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "20em") %>%
  #   column_spec(2:3, width = "2.5em", latex_valign = "m") %>% 
  column_spec(3:4, width = "4em", latex_valign = "m")

```


Todos los experimentos previamente descriptos usan la configuración del ensamble multifísica y del sistema de asimilación explicada en la Sección \@ref(configmodelo). De la misma manera los ciclos de análisis horarios se realizan desde las 18 UTC del 20 de noviembre hasta las 12 UTC del 23 de noviembre para cubrir el desarrollo y maduración del SCM. 

Para estudiar el impacto de la asimilación de radianzas también se generaron pronósticos determinísticos en alta resolución inicializados a las 00 y 06 UTC del 22 de noviembre (Figura \@ref(fig:cycle-fcst)). En la Figura \@ref(fig:dominio-det) se muestra el dominio *d01* con 10 km de resolución (línea negra), identico al dominio utilizado para el resto de las simulaciones num'ericas y el dominio anidado *d02* con 2 km de resolución (línea turquesa). Las condiciones iniciales están dadas por los análisis de los distintos experimentos y las condiciones de borde son generadas a partir del GFSF determinístico. Además las variables atmosféricas para el *d02* fueron inicializadas haciendo un escalado de la información del análisis. Todos los pronósticos utilizan las mismas parametrizaciones: del modelo de superficie terrestre (Noah-MP, @chen2001), de microfísica (esquema de un solo momento de 6 clases del WRF, @hong2006a) de procesos radiativos (esquema de onda corta y onda larga del RRTMG, @iacono2008), YSU [@hong2006] para capa límite y KF [@kain2004] para covección (solo aplicado al *d01*).

Además de los pronósticos inicializados a partir de los análisis, se generaron pronósticos inicializados a partir de GFS, es decir, sin asimilación de datos regional. Estos pronósticos tienen la misma configuración y usan el mismo conjunto de parametrizaciones que los los pronósticos descriptos previamente. 

(ref:dominio-det) Dominio de baja resolución (d01, 10 km) marcado con un recuadro negro y dominio anidado de alta resolución (d02, 2 km) marcado en color turquesa. 

```{r dominio-det, fig.cap="(ref:dominio-det)", fig.width=3, fig.height=3, fig.align="center"}
# ReadNetCDF("/home/paola.corrales/datosmunin3/EXP/E10/FCST/2018112200_det/wrfout_d02_2018-11-22_00:00:00", vars = c("XLAT", "XLONG")) %>% 
#   setnames(c("XLAT", "XLONG"), c("lat", "lon")) %>% 
#   write_csv("/home/paola.corrales/datosmunin3/EXP/paper_ana_20181122-derived_data/sample_obs/dominio_d02.csv")

square_d02 <- fread(here("data/derived_data/sample_obs/dominio_d02.csv")) %>% 
  .[, square1 := west_east %in% range(west_east) , by = .(south_north)] %>% 
  .[, square2 := south_north %in% range(south_north) , by = .(west_east)] %>% 
  .[square1 | square2] 


dominio <- fread(here("data/derived_data/sample_obs/dominio_hgt.csv")) %>% 
  .[, c("x", "y") := wrf_project(lon, lat)]

dominio %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = hgt), proj = norargentina_lambert,
                    breaks = seq(0, 6000, 500)) +
  scale_fill_gradient(low = "#f2f2f2", high = "#333333",
                      name = NULL,
                      breaks = seq(0, 6000, 1000),
                      guide = NULL) +
  geom_mapa() +
  geom_point(data = square, aes(lon, lat), size = 0.2) +
  geom_point(data = square_d02, aes(lon, lat), size = 0.2, color = "#047994") +
  annotate("text", x = -73.5, y = -40.5, color = "black", label = "d01", size = 3) +
  annotate("text", x = -66, y = -39.5, color = "#047994", label = "d02", size = 3) +
  theme_minimal(base_size = 10) +
  theme(legend.box = "horizontal",
        legend.position = c(0.1, 0.95),
        legend.background = element_rect(fill = "white", color = "white")) 

```


## Resultados

### Sensibilidad a la combinación de canales {#canales}

Trabajos previos evaluaron el impacto de asimilar observaciones de los canales asociados al vapor de agua de ABI en escala regional. En líneas general estos trabajos (@lee2019, @jones2020, entre otros) utilizan las observaciones de los 3 canales en conjunto. Sin embargo @honda2018 encontraron mejores resultado al asimilar los canales 8 (6.2 $\mu m$) y 10 (7.3 $\mu m$) observando que el canal 9 (6.9 $\mu m$) está muy correlacionado con los dos primeros y por lo tanto no aporta información independiente en la asimilación. Por otro lado @lee2019 observaron que el impacto era mayor al asimilar observaciones de los 3 canales sobre el continente y el mar al mismo tiempo. También observaron que el incremento del análisis disminuye considerablemente al remover el canal 10 y en algunos casos también el canal 9.

En este trabajo se generaron 3 experimentos de prueba que comparten la misma configuración que los experimentos previamente descriptos pero utilizando distintas combinaciones de canales de ABI. El experimento ABI_ch890_th30 asimila observaciones de los 3 canales, ABI_ch90_th30 asimila observaciones de los 9 y 10 (vapor de agua en niveles medios y bajos respectivamente) y ABI_ch0_th30 solo utliza observaciones del canal 10. Estos 3 experimentos utilizan un thinning de 30 km como primera aproximación, un análisis más detallado del thinning se realizará en la siguiente Sección.

(ref:area-canales) Porcentaje de área cubierta por precipitación a 1 hora superior a a) $1 mmh^{-1}$, b) $5 mmh^{-1}$ y c) $10 mmh^{-1}$ a lo largo del tiempo para el campo preliminar de los experimentos SATWND (línea naranja), ABI_ch890_th30 (línea verde), ABI_ch90_th30 (línea violeta) y ABI_ch0_th30 (línea celeste) entre las 00 UTC del 22 de noviembre y las 12 UTC del 23 de noviembre en el dominio de verificación (cuadro rojo en la Figura \@ref(fig:dominio)a). En sombreado y para cada experimento se muestra el área máxima y mínima estimada por el ensamble del análisis. En línea continua negra se muetra la estimación de IMERG.

```{r area-canales, fig.cap="(ref:area-canales)", fig.width=6, fig.height=5}
colores_canales <- c(E6 = "#EE7733", EG2 = "chartreuse4", EG4 = "#845EC2",
                     EG5 = "#2B809B")

imerg <- read_rds(here("data/derived_data/observations/IMERG_1h.rds"))

q <- c(1, 5, 10, 25, 50)
# lon_band = c(-67, -54.5)
# lat_band = c(-38.5, -21)
lon_band = c(-66.5, -61.5)
lat_band = c(-35.5, -29)
imerg <- purrr::map(q, function(f){
  
  imerg %>%
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
    .[lon %between% lon_band & lat %between% lat_band] %>%
    .[, .(area = sum(pp_acum > f)/.N), by = .(end_date)] %>%
    .[, umbral := f] %>%
    .[]
}) %>%
  rbindlist()


files <- Sys.glob(here("data/derived_data/analysis_variables/pp_area/E*_ana*_area_acum_*.rds"))

# files <- Sys.glob("~/datosmunin3/EXP/derived_data/ppacum/E*[0234569]_ana*_area_acum_*.rds")

pp_area <- purrr::map(files, function(f) {
  
  readRDS(f)
  # %>% 
  #   .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)]
  
}) %>% rbindlist()

pp_area %>% 
  .[umbral %in% c(1, 5, 10) & exp %in% c("E6", "EG2", "EG4", "EG5")] %>% 
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp)] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5, 10)], 
            aes(end_date, area, color = "OBS"),
            linetype = 2) +
  geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp), alpha = .1) +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = c(OBS = "grey20", colores_canales),
                     labels = c(E6 = "SATWND",
                                EG2 = "ABI_ch890_th30", EG4 = "ABI_ch90_th30",
                                EG5 = "ABI_ch0_th30", OBS = "OBS")) +
  scale_fill_manual(values = c(OBS = "grey20", colores_canales),
                    guide = NULL,
                    labels = c(E6 = "SATWND",
                               EG2 = "ABI_ch890_th30", EG4 = "ABI_ch90_th30",
                               EG5 = "ABI_ch0_th30", OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_wrap(~umbral, scales = "free_y", 
             labeller = labeller(umbral = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"))) +
  tagger::tag_facets() +
  labs(y = "Área cubierta por precipitación (%)", x = NULL, 
       fill = NULL, color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

La Figura \@ref(fig:area-canales) muestra el porcetanje de área cubierta por precipitación superior a distintos umbrales y compara los experimentos para estudiar la sensibilidad al uso de canales con SATWND como experimento control y la estimación de precipitación de IMERG. Al igual que en otros experimentos, los experimentos ABI subestiman la precipitación observada y tienen además un comportamiento similar a SATWND. En algunos casos, logran representar mejor la precipitación que SATWND particularmente para umbrales de precipitación mayores (Figura \@ref(fig:area-canales)b-c) y algunas subregiones como la provincia de Córdoba (no se muestra). Comparando los experimentos ABI entre si, no se observan grandes diferencias y solo en algunos casos ABI_ch890_th30 es mejor que los otros dos. Desde este punto de vista, la asimilación de las observaciones de los canales 8 y 9 en niveles altos y medios no aporta mucha información al análisis.

Desde el punto de vista del FSS (Figura \@ref(fig:fss-canales)) los experimentos que incluyen observaciones de ABI tienen un rendimiento mucho mejor que SATWND. Además, los 3 experimentos de ABI tienen un comportamiento similar entre si aunque en este caso ABI_ch890_th30 representa ligeramente mejor la precipitación por encima de 25 mm (Figuras \@ref(fig:fss-canales)b y d). 

Teniendo en cuenta que la asimilación de los 3 canales de ABI en conjunto no degradan el análisis y por el contrario, en algunos casos parecen tener un rendimiento mejor, para los experimentos de de este capítulo se asimilaran los 3 canales asociados al vapor del agua al mismo tiempo. 

(ref:fss-canales) FSS calculado sobre la precipitación acumulada a 1 hora en una ventana móvil de 6 horas para umbrales de 1 mm (a y c) y 25 mm (b y d), en escalas de 10 km (a y b) y 100 km (c y d), para el campo preliminar de los experimentos SATWND (línea naranja), ABI_ch890_th30 (línea verde), ABI_ch90_th30 (línea violeta) y ABI_ch0_th30 (línea celeste).

```{r fss-canales, fig.cap="(ref:fss-canales)", fig.width=5, fig.height=5}

files <- c(Sys.glob(here("data/derived_data/FSS/fss_6h_ana_ens_EG[2345]*")),
           Sys.glob(here("data/derived_data/FSS/fss_6h_ana_ens_E[169]*.csv")))

fss <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "fss_6h_ana_ens_{exp}.csv")
  
  fread(f) %>% 
    .[, date := as_datetime(date)] 
}) %>% 
  rbindlist()

fss %>% 
  .[q %in% c(1, 25) & w %in% c(1, 11) & exp %in% c("E6", "EG2", "EG4", "EG5")] %>% 
  .[, ":="(q_label = factor(q, labels = c("1~mm~h^{-1}", "25~mm~h^{-1}")),
           w_label = factor(w, labels = c("10~km", "100~km")))] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = colores_canales, 
                     labels = c(E6 = "SATWND", 
                                EG2 = "ABI_ch890_th30", EG4 = "ABI_ch90_th30",
                                EG5 = "ABI_ch0_th30")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  coord_cartesian(xlim = c(ymd_hms(20181122000000), ymd_hms(20181123120000))) +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```


### Sensibilidad al thinning {#thinning}

En la asimilación de datos y en particular de radianzas de satélites, muchas observaciones con alta resolución espacial debe ser descartadas porque podrían tener un impacto negativo en el análisis al no ser independientes entre si. En los esquemas de asimilación actuales se asume que la matriz de covarianza de los errores de las observaciones $R$ es diagonal, es decir, no hay correlación entre los errores de las distintas observaciones y cada observación es independiente. En este contexto estrategias como el thinning para disminuir la resolución de las observaciones conservando la información que aportan son claves. 

Existen diversos algoritmos para realizar el thinning, GSI en particular utiliza una metodología simple que consiste en definir una retícula de baja resolución y seleccionar las observaciones en alta resolución de acuerdo la distancia de estás a los puntos de la retícula gruesa y según criterios de calidad descriptos en la Sección \@ref(sat). 

Es importante definir entonces la resolución apropiada para la reticula de baja resolución y estudiar el impacto que esto tiene en el análisis. Para esto se realizaron 2 experimentos ABI_ch890_th30 con un thinning de 30 km, es decir, que lleva las observaciones con una resolución de 2 km a una reticula de 30 km, y ABI_ch890_th10 con un thinning de 10 km, igual a la resolución de las simulaciones numéricas. 

(ref:area-thinning) Porcentaje de área cubierta por precipitación a 1 hora superior a a) $1 mmh^{-1}$, b) $5 mmh^{-1}$ y c) $10 mmh^{-1}$ a lo largo del tiempo para el campo preliminar de los experimentos SATWND (línea naranja), ABI_ch890_th30 (línea verde), y ABI_ch890_th10 (línea celeste) entre las 00 UTC del 22 de noviembre y las 12 UTC del 23 de noviembre en el dominio de verificación (cuadro rojo en la Figura \@ref(fig:dominio)a). En sombreado y para cada experimento se muestra el área máxima y mínima estimada por el ensamble del análisis. En línea continua negra se muetra la estimación de IMERG.

```{r area-thinning, fig.cap="(ref:area-thinning)", fig.width=6, fig.height=5}
colores_thinning <- c(E6 = "#EE7733", EG2 = "chartreuse4", EG3 = "#047994")

pp_area %>% 
  .[umbral %in% c(1, 5, 10) & exp %in% c("E6", "EG2", "EG3")] %>% 
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp)] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5, 10)], 
            aes(end_date, area, color = "OBS"),
            linetype = 2) +
  geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp), alpha = .1) +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = c(OBS = "grey20", colores_thinning),
                     labels = c(E6 = "SATWND",
                                EG2 = "ABI_ch890_th30", EG3 = "ABI_ch890_th10",
                                OBS = "OBS")) +
  scale_fill_manual(values = c(OBS = "grey20", colores_thinning),
                    guide = NULL,
                    labels = c(E6 = "SATWND",
                               EG2 = "ABI_ch890_th30", EG3 = "ABI_ch890_th10",
                               OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_wrap(~umbral, scales = "free_y", 
             labeller = labeller(umbral = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"))) +
  tagger::tag_facets() +
  labs(y = "Área cubierta por precipitación (%)", x = NULL, 
       fill = NULL, color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

Nuevamente compararemos los experimentos desde el punto de vista de la precipitación. En particular la Figura \@ref(fig:area-thinning) muestra el porcentaje de área cubierta por precipitación superior a distintos umbrales a lo largo del tiempo para los experimentos de thinning y SATWND como experimento control. En todos los casos el experimento con un thinning de 10 km es el que representa mejor el área cuberta por precipitación, particularmente en las horas de mayor actividad convectiva. Si bien todos los experimentos subestiman la precipitación en comparación con IMERG, ABI_ch890_th10 se acerca a esta estimación sobre todo cuando observamos el valor máximo del ensamble. 

```{r thinning-fss, fig.cap="(ref:thinning-fss)", fig.width=5, fig.height=5}

fss %>% 
  .[q %in% c(1, 25) & w %in% c(1, 11) & exp %in% c("E6", "EG2", "EG3")] %>% 
  .[, ":="(q_label = factor(q, labels = c("1~mm~h^{-1}", "25~mm~h^{-1}")),
           w_label = factor(w, labels = c("10~km", "100~km")))] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = colores_thinning, 
                     labels = c(E6 = "SATWND", 
                                EG2 = "ABI_ch890_th30", EG3 = "ABI_ch890_th10")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  coord_cartesian(xlim = c(ymd_hms(20181122000000), ymd_hms(20181123120000))) +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

Desde el punto de vista del FSS y para $1 mm h^{-1}$ (Figura \@ref(fig:thinning-fss)a y c) ABI_ch890_th10 tiene igual o mejor rendimiento que ABI_ch890_th30 pero ocurre lo contrario para el umbral de $25 mm h^{-1}$ (Figura \@ref(fig:thinning-fss)b y d). Si bien las diferencias de FSS entre los experimentos de thinning son muy pequeñas, el área cubierta por precipitación y otros análisis no mostrados en esta Sección, resalta la necesidad de utilizar un thinning cercano a la resolución del modelo. Por esta razón la configuración de thinning a utilizar en los experimentos posteriores será de 10 km. 

### Comparación del impacto de observaciones de GOES-16 con otras fuentes de información

#### Impacto de las observaciones de ABI en el análisis

Al igual que en la Sección \@ref(impacto-analisis), es importante primero entender el impacto de asimilar este conjunto de observaciones en el análisis. En particular, este impacto podría variar en presencia de otros conjuntos de observaciones tales como otras radianzas de satélites polares. Por esta razón se comparará el experimento ABI (previamente ABI_ch890_th10) que asimila los 3 canales de vapor de agua con SATWND donde no se asimilan radianzas y es considerado el experimento control, RAD donde se asimilan radianzas de satelites en orbitas polares y RAD+ABI donde se incluyen todas las observaciones al mismo tiempo. De esta manera podremos evaluar cuál es el impacto de de las observaciones de ABI de manera independiente y cuando son asimiladas en conjunto con radianzas de satélites polares.   

En primer lugar calculamos perfiles verticales de temperatura y humedad específica promediados espacialmente a partir de la media del ensambel de cada experimento a lo largo de todo el periodo. Posteriormente para evaluar el impacto de la asimilación de las radianzas, calculamos la diferencia entre los perfiles verticales de los experimentos con estas observaciones y SATWND que no as incluye (Figura \@ref(fig:TQ-diff-abi)). Previamente habíamos observado que la asimilación de radianzas de satélites polares producía un calentamiento en niveles bajos (Figura \@ref(fig:TQ-diff-abi)a), la asimilación de observaciones de ABI en este caso produce, además, un enfriamento en niveles medios y un calentamiento previo al paso del frente frío y desarrollo de la convección durante el 21 de noviembre. Al comparar la diferencia entre los perfiles verticales de cada experimento y ERA5 (Figuras \@ref(fig:era5-abi)a-d), vemos que este enfriamiento en niveles medios (Figura \@ref(fig:era5-abi)c-d) produce una mayor diferencia entre los análisis que incluyen ABI y ERA5. 

La diferencia en la humedad específica para los distintos experimentos se muestra en las Figuras \@ref(fig:TQ-diff-abi)d-f, dodne vemos que la asimilación de observaciones de ABI produce un humedecimiento por encima de 750 hPa y este efecto es mayor cuando no se asimilan radianzas de satélites polares (Figura \@ref(fig:TQ-diff-abi)f). 

(ref:TQ-diff-abi) Diferencia entre la media del ensamble de los análisis a) y d) RAD-SATWND, b) y e) RAD+ABI-SATWND, y c) y f) ABI-SATWND para los perfiles verticales espacialmente promediados de la temperatura (a, b y c, en $K$) y la humedad específica (d, e y f en $g\ kg^{-1}$) calculados sobre el dominio interior (recuadro rojo en la Figura \@ref(fig:dominio)a) para cada ciclo de análisis. Nuevamente, la diferencia entre los experimentos y ERA5 para esta variable (Figuras \@ref(fig:era5-abi)e-h) muestra que la asimilación de obsevaciones de ABI aleja los análisis del estado de la atmósfera que representa ERA5.

```{r TQ-diff-abi, fig.cap="(ref:TQ-diff-abi)", fig.height=5.5, fig.width=7, fig.align="center"}
files <- Sys.glob(here("data/derived_data/analysis_variables/perfiles_ana_E*.csv"))

perfiles <- purrr::map(files, function(f) {
  exp <- unglue(basename(f), "perfiles_{run}_{exp}.csv")
  fread(f) %>% 
    .[, exp := exp[[1]][["exp"]]]
  
}) %>% 
  rbindlist() %>% 
  .[exp %in% c("E6", "E9", "E10", "EG3")] %>% 
  .[, date := as_datetime(date)] %>% 
  .[date %between% c(as_datetime("2018-11-20 18:00:00"),
                     as_datetime("2018-11-23 12:00:00"))]


perfiles %>% 
  dcast(lev + date ~ exp, value.var = "T") %>% 
  .[, ":="(E9_E6 = E9 - E6,
           E10_E6 = E10 - E6,
           EG3_E6 = EG3 - E6)] %>% 
  melt(measure.vars = c("E9_E6", "E10_E6", "EG3_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level)),
                    breaks = c(seq(-1.2, 1, 0.2), Inf)) +
  geom_contour2(aes(z = value), color = "white", size = 0.05,
                breaks = c(seq(-1.2, 1, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black"), 
                                   labels = scales::number_format()) +
  labs(fill = "Temperatura (K)",
       x = NULL,
       y = "Presión (hPa)") +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E9_E6" = "RAD - SATWND",
                                              "E10_E6" = "RAD+ABI - SATWND",
                                              "EG3_E6" = "ABI - SATWND"))) +
  tag_facets(position = list(x = 0.1, y = 0.96)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  
  perfiles %>% 
  dcast(lev + date ~ exp, value.var = "QVAPOR") %>% 
  .[, ":="(E9_E6 = E9 - E6,
           E10_E6 = E10 - E6,
           EG3_E6 = EG3 - E6)] %>% 
  melt(measure.vars = c("E9_E6", "E10_E6", "EG3_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value*1000, fill = stat(level)), 
                    breaks = c(seq(-1.4, 1, 0.2), Inf)) +
  geom_contour2(aes(z = value), color = "white", size = 0.05,
                breaks = c(seq(-1.4, 1, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3, 
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black"),
                                   labels = scales::number_format()) +
  
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  labs(fill = latex2exp::TeX("Humedad \nespecífica ($g$ $Kg^{-1}$)"),
       y = "Presión (hPa)",
       x = NULL) +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E9_E6" = "RAD - SATWND",
                                              "E10_E6" = "RAD+ABI - SATWND",
                                              "EG3_E6" = "ABI - SATWND"))) +
  tag_facets(tag_pool = c("d", "e", "f"), position = list(x = 0.1, y = 0.96)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  plot_layout(ncol = 1, heights = c(1, 1))

```
(ref:UV-diff-abi) Diferencia entre la media del ensamble de los análisis a) y d) RAD-SATWND, b) y e) RAD+ABI-SATWND, y c) y f) ABI-SATWND para los perfiles verticales espacialmente promediados del viento zonal (a, b y c, en $K$) y viento meridional (d, e y f en $g\ kg^{-1}$) calculados sobre el dominio interior (recuadro rojo en la Figura \@ref(fig:dominio)a) para cada ciclo de análisis. Los contornos negros corresponden al viento zonal y meridional para (a,d) RAD, (b,e) RAD+ABI, y (c,f) ABI ya que son los experimentos tienen más observaciones asimiladas en cada panel.

```{r UV-diff-abi, fig.cap="(ref:UV-diff-abi)", fig.height=5.5, fig.width=7, fig.align="center"}
perfiles %>% 
  dcast(lev + date ~ exp, value.var = "U") %>% 
  .[, ":="(E9_E6 = E9 - E6,
           E10_E6 = E10 - E6,
           EG3_E6 = EG3 - E6)] %>% 
  melt(measure.vars = c("E9_E6", "E10_E6", "EG3_E6")) %>% 
  ggplot(aes(date, lev)) +
  # geom_contour(aes(z = value)) +
  geom_contour_fill(aes(z = value, fill = stat(level)), breaks = c(seq(-2, 2, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3, 
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  geom_contour2(aes(z = value), color = "white", size = 0.05,
                breaks = c(seq(-2, 2, 0.2), Inf)) +
  geom_contour2(data = ~.x[, .(lev, date, E9_E6 = E9, E10_E6 = E10, EG3_E6 = EG3)] %>%
                  melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value),
                breaks = seq(0, 30, 3), size = 0.1, linetype = 1, color = "grey30") +
  geom_text_contour(data = ~.x[, .(lev, date, E9_E6 = E9, E10_E6 = E10, EG3_E6 = EG3)] %>%
                      melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value),
                    breaks = seq(0, 30, 3), color = "grey30", skip = 1,
                    size = 2, stroke = 0.1) +
  labs(fill = latex2exp::TeX("U ($m$ $s^{-1}$)"),
       x = NULL,
       y = NULL) +
  scale_y_level(name = "Pressure (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E9_E6"  = "**RAD** - SATWND",
                                              "E10_E6" = "**RAD+ABI** - SATWND",
                                              "EG3_E6" = "**ABI** - SATWND"))) +
  tag_facets(position = list(x = 0.1, y = 0.96)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3), 
        strip.text = ggtext::element_markdown()) +
  
  
  perfiles %>% 
  dcast(lev + date ~ exp, value.var = "V") %>% 
  .[, ":="(E9_E6 = E9 - E6,
           E10_E6 = E10 - E6,
           EG3_E6 = EG3 - E6)] %>% 
  melt(measure.vars = c("E9_E6", "E10_E6", "EG3_E6")) %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = value, fill = stat(level)), 
                    breaks = c(-Inf, seq(-3, 2, 0.2), Inf)) +
  geom_contour2(aes(z = value), color = "white", size = 0.05,
                breaks = c(-Inf, seq(-3, 2, 0.2), Inf)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3, 
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black"),
                                   labels = function(x) JumpBy(x, 2, fill = "")) +
  geom_contour2(data = ~.x[, .(lev, date, E9_E6 = E9, E10_E6 = E10, EG3_E6 = EG3)] %>%
                  melt(id.vars = c("lev", "date")) %>% unique(),
                aes(z = value, linetype = factor(-sign(..level..))),
                breaks = seq(-10, 4, 2), size = 0.1, color = "grey30") +
  geom_text_contour(data = ~.x[, .(lev, date, E9_E6 = E9, E10_E6 = E10, EG3_E6 = EG3)] %>%
                      melt(id.vars = c("lev", "date")) %>% unique(), aes(z = value),
                    breaks = seq(-10, 4, 2), color = "grey30", skip = 1,
                    size = 2, stroke = 0.1) +
  labs(fill = latex2exp::TeX("V ($m$ $s^{-1}$)"),
       x = NULL,
       y = NULL) +
  scale_linetype(guide = NULL) +
  scale_y_level(name = "Pressure (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(~variable, ncol = 3,
             labeller = labeller(variable = c("E9_E6"  = "**RAD** - SATWND",
                                              "E10_E6" = "**RAD+ABI** - SATWND",
                                              "EG3_E6" = "**ABI** - SATWND"))) +
  tag_facets(tag_pool = c("d", "e", "f"), position = list(x = 0.1, y = 0.96)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.text = ggtext::element_markdown()) +
  plot_layout(ncol = 1, heights = c(1, 1))


```

Las Figuras \@ref(fig:UV-diff-abi) muestran la comparación entre los experimentos que incluyen radianzas de satélite y SATWND para las componentes del viento. En este caso las diferencias entre experimentos son más sutiles sin embargo se aprecia una disminución en el viento zonal por encima de la 700 hPa en los experimentos RAD+ABI y ABI. Este aumento es más marcado cuando se asimilan radianzas de satélites polares y GOES en conjunto. En ese caso la comparación con ERA5 (Figuras \@ref(fig:era5-abi)i-l) muestra el viento zonal en los experimentos RAD y ABI se acerca más a ERA5 que SATWND que no incluye radianzas o RAD+ABI que asimila todas las radianzas en conjunto. En niveles bajos las diferencias son pequeñas y solo se observa un ligero aumento del viento zonal en ABI respecto de SATWND (Figura \@ref(fig:UV-diff-abi)c) asociado al flujo postfrontal. 

Las Figuras \@ref(fig:UV-diff-abi)d-f muestran que los experimentos que asimilan ABI tienen una mayor diferencia respecto de SATWND en el viento meridional en altura a partir del 22 de noviembre a las 2 UTC cuando hay mayor convección en el dominio. Este efecto ya era notorio al analizar el impacto de las radianzas de satelites polares (Figura \@ref(fig:UV-diff)f) que ahora se intensifica cuando se incluyen radianzas de GOES. Al igual que para el viento meridional, la comparación entre los experimentos y ERA5 (Figuras \@ref(fig:era5-abi)m-o)) muestra que, por encima de 500 hPa, los experimentos que incliyen radianzas tienen un viento meridional más parecido a ERA5 que SATWND. Esta mejora es más notoria en ABI donde no se incluyen observaciones de satélites polares. 

(ref:era5-abi) Diferencia entre la media del ensamble del análisis de cada experimento y el ERA5 para los perfiles verticales espacialmente promediados de la temperatura del aire (K, a--d), la humedad específica ($g\ Kg^{-1}$, e--h) y el viento meridional ($m\ s^{-1}$, i--l) calculados sobre el dominio interior (recuadro rojo en la Figura \@ref(fig:dominio)a) para cada ciclo de análisis.

```{r era5-abi, fig.cap="(ref:era5-abi)", fig.width=6.5, fig.height=8, fig.align="center"}
era <- fread(here("data/derived_data/reanalysis/perfiles_ana_era5.csv"))

era[perfiles, on = c("lev", "date")] %>% 
  .[, exp := factor(exp, levels = c("E6", "E9", "E10", "EG3"))] %>% 
  # .[lev != 1000] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = i.T - T, fill = stat(level)), 
                    breaks = seq(-3, 3, 0.5)) +
  geom_contour2(aes(z = i.T - T), color = "white", size = 0.05,
                breaks = seq(-3, 3, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(vars(exp), ncol = 4, labeller = labeller(exp = c(E6 = "SATWND", E9 = "RAD", 
                                                              E10 = "RAD+ABI", EG3 = "ABI"))) +
  labs(fill = "Temperatura (K)",
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  era[perfiles, on = c("lev", "date")] %>% 
  .[, exp := factor(exp, levels = c("E6", "E9", "E10", "EG3"))] %>% 
  # .[lev != 1000] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = i.QVAPOR - QVAPOR, fill = stat(level)), 
                    breaks = seq(-0.0025, 0.0015, 0.0004)) +
  geom_contour2(aes(z = i.QVAPOR - QVAPOR), color = "white", size = 0.05,
                breaks = seq(-0.0025, 0.0015, 0.0004)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(vars(exp), ncol = 4, labeller = labeller(exp = c(E6 = "SATWND", E9 = "RAD", 
                                                              E10 = "RAD+ABI", EG3 = "ABI"))) +
  labs(fill = latex2exp::TeX("Humedad \nespecífica ($g$ $Kg^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95), tag_pool = c("e", "f", "g", "h")) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
    era[perfiles, on = c("lev", "date")] %>% 
  .[, exp := factor(exp, levels = c("E6", "E9", "E10", "EG3"))] %>% 
  # .[lev != 1000] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = i.U - U, fill = stat(level)), 
                    breaks = seq(-4, 5, 0.5)) +
  geom_contour2(aes(z = i.U - U), color = "white", size = 0.05,
                breaks = seq(-4, 5, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(vars(exp), ncol = 4, labeller = labeller(exp = c(E6 = "SATWND", E9 = "RAD", 
                                                              E10 = "RAD+ABI", EG3 = "ABI"))) +
  labs(fill = latex2exp::TeX("U ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95), tag_pool = c("i", "j", "k", "l")) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  era[perfiles, on = c("lev", "date")] %>% 
  .[, exp := factor(exp, levels = c("E6", "E9", "E10", "EG3"))] %>% 
  # .[lev != 1000] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = i.V - V, fill = stat(level)), 
                    breaks = seq(-4, 7, 1)) +
  geom_contour2(aes(z = i.V - V), color = "white", size = 0.05,
                breaks = seq(-4, 7, 1)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_wrap(vars(exp), ncol = 4, labeller = labeller(exp = c(E6 = "SATWND", E9 = "RAD", 
                                                              E10 = "RAD+ABI", EG3 = "ABI"))) +
  labs(fill = latex2exp::TeX("V ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95), tag_pool = c("m", "n", "ñ", "o")) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) +
  
  plot_layout(ncol = 1, heights = c(1, 1, 1, 1)) 
```
Habiendo analizado el impacto de la asimilación de radianzas en términos generales, la Figura \@ref(fig:sondeos-abi) muestra el RMSE y BIAS calculado al comparar los experimentos con los radiosondeos de RELAMPAGO en la región que se observa la Figura \@ref(fig:dominio)b. Por debajo de 5 km las observaciones de GOES generan una degradación de la temperatura de rocío durante el IOP 7 y de la temperatura en el IOP 8 con aumento tanto del RMSE como del BIAS. Pero se observa una mejora en la representación del viento zonal y meridional en niveles bajos durante el IOP 8. Sin embargo, las mayores diferencias entre SATWND o RAD y los experimentos que incluyen observaciones de GOES se observan por encima de 5 km donde se ubican los máximos de las funciones de peso de los canales de vapor de agua (Figura \@ref(fig:wf-goes)). La asimilación de observacionesde GOES ayuda a disminuir el RMSE y el BIAS en todas las variables durante el IOP 7. Este IOP estuvo caracterizado ser un periodo relativament estable con cielos mayoritariamente despejados y un flujo de norte en niveles bajos asociado a una advección cálida y húmeda por lo que se asimilaron una mayor cantidad de observaciones de radianzas en comparación con el día siguiente. Esta es una de las razones que podrían explicar el impacto que se observa en todas las variables. Durante el IOP 8 las mejoras se observan principalmente en la temperatura y temperatura de punto de rocío y en menor medida en el viento meridional en niveles altos. Finalmente, la característica sobresaliente de este análisis es la mejora sustancial en la representación de la humedad en niveles medios cuando se asimilan observaciones de GOES. Si bien esto es opuesto a lo observado al analizar las diferencias entre ABI y RAD+ABI con ERA5, es importante notar en este punto que esta última comparación tiene límitaciones tanto por la resolución del reanálisis como por las observaciones disponibles para su generación.     


(ref:sondeos-abi) RMSE (línea sólida) y Bias (línea discontinua) de a) la temperatura ($K$), b) la temperatura del punto de rocío ($K$), c) el viento u ($m\ s^{-1}$) y d) el viento v ($m\ s^{-1}$) calculados comparando el análisis de cada experimento con los sondeos de RELAMPAGO durante el IOP 7 y el IOP 8. La línea naranja corresponde a SATWND, la línea roja a RAD, RAD+ABI se representa con una línea verde y ABI con una línea turqueza.

```{r sondeos-abi, fig.cap="(ref:sondeos-abi)", fig.width=6, fig.height=4, fig.align="center"}
colores_exp_abi <- c(E6 = "#EE7733", E9 = "#CC3311", E10 = "#93B75C", EG3 = "#047994")

files <- c(Sys.glob(here("data/derived_data/soundings/sondeo_E[169]*_ana*")),
           Sys.glob(here("data/derived_data/soundings/sondeo_EG3_ana*")))

sondeos <- purrr::map(files, function(f){
  
  out <- fread(f) %>% 
    .[, value := fifelse(variable %in% c("t", "td"), value + 273.15, value)] %>% 
    .[, launch_time := as_datetime(launch_time)]
  
}) %>% 
  rbindlist()

IOP <- tribble(
  ~iop, ~ini, ~end,
  "IOP07", ymd_hms("20181121150000"), ymd_hms("20181121210000"),
  "IOP08", ymd_hms("20181122140000"), ymd_hms("20181122200000")
) %>% setDT()


sondeos %>% 
  .[, iop := fcase(launch_time %between% c(ymd_hms("20181121150000"), ymd_hms("20181121210000")), "IOP07",
                   launch_time %between% c(ymd_hms("20181122140000"), ymd_hms("20181122200000")), "IOP08")] %>% 
  .[variable %in% c("t", "td", "u", "v") & !str_detect(site, "/") & !is.na(fcst_value) & !is.na(iop)] %>% 
  .[site != "Sao Borja, Brazil"] %>% 
  .[, lev := cut_round(alt, c(seq(0, 3000, 500), seq(4000, 21000, 1000)))] %>% 
  .[, ":="(RMSE = mean(sqrt((fcst_value - value)^2), na.rm = TRUE), 
           BIAS = mean(fcst_value - value, na.rm = TRUE)), by = .(iop, exp, variable, lev)] %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico", value.name = "value.est") %>% 
  .[lev <= 15000] %>% 
  .[, ":="(iop_labels = factor(iop, labels = c("IOP~7", "IOP~8")),
           variable_labels = factor(variable, labels = c("Temperatura~(K)", "atop('Temperatura de', 'punto de rocío (K)')", "Viento~U~(m~s^{-1})", "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(lev/1000, value.est)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = estadistico)) +
  scale_color_manual(values = c(colores_exp_abi), labels = c(E6 = "SATWND", E9 = "RAD",
                                                             E10 = "RAD+ABI", EG3 = "ABI")) +
  coord_flip() +
  facet_grid(iop_labels ~ variable_labels, scales = "free_x", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.95)) +
  labs(y = "Bias/RMSE", x = "Altura (Km)", color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

##### Impacto en la precipitación

En esta Sección ponemos el foco nuevamente en la precipitación para evaluar la habilidad de los análisis al representar la precipitación acumulada horaria del first-guess cuando incluyen o no información de las observaciones de GOES. En primer lugar analizamos el porcetaje de área cubierta por precipitación para distintos umbrales (Figuras \@ref(area-abi)) donde se observa una mejora cosiderable en el área tanto en magnitud como en ubicación temporal para los experimentos RAD+ABI y RAD cuando se los compara con SATWND que no asimila radianzas. 

En este punto es interesante observar las posibles diferencias entre RAD+ABI y ABI para evaluar el aporte de las radianzas de satélites polares cuando se asimilan en conjunto con radianzas de GOES. Desde el punto de vista del área cubierta por precipitación, las diferencias son pequeñas, RAD+ABI subestima el área previo al máximo de precipitación respecto de ABI y lo contrario ocurre posterior al máximo. Esto podría indicar las que las radianzas de GOES son suficientes para representar la precipitación y que la asimilación de radianzas de satélites polares no agrega información, al menos para este caso de estudio. 

(ref:area-abi) Porcentaje de área cubierta por precipitación a 1 hora superior a a) $1 mmh^{-1}$, b) $5 mmh^{-1}$ y c) $10 mmh^{-1}$ a lo largo del tiempo para el campo preliminar de los experimentos SATWND (línea naranja), RAD (línea roja), RAD+ABI (línea verde), y ABI (línea turqueza) entre las 00 UTC del 22 de noviembre y las 12 UTC del 23 de noviembre en el dominio de verificación (cuadro rojo en la Figura \@ref(fig:dominio)a). En sombreado y para cada experimento se muestra el área máxima y mínima estimada por el ensamble del análisis. En línea continua negra se muetra la estimación de IMERG.

```{r area-abi, fig.cap="(ref:area-abi)", fig.width=6, fig.height=5}

pp_area %>% 
  .[umbral %in% c(1, 5, 10) & exp %in% c("E6", "E9", "E10", "EG3")] %>% 
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp)] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5, 10)], 
            aes(end_date, area, color = "OBS"),
            linetype = 2) +
  geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp), alpha = .1) +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = c(OBS = "grey20", colores_exp_abi),
                     labels = c(E6 = "SATWND", E9 = "RAD",
                                E10 = "RAD+ABI", EG3 = "ABI", OBS = "OBS")) +
  scale_fill_manual(values = c(OBS = "grey20", colores_exp_abi),
                    guide = NULL,
                    labels = c(E6 = "SATWND", E9 = "RAD",
                               E10 = "RAD+ABI", EG3 = "ABI", OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_wrap(~umbral, scales = "free_y", 
             labeller = labeller(umbral = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"))) +
  tagger::tag_facets() +
  labs(y = "Área cubierta por precipitación (%)", x = NULL, 
       fill = NULL, color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

Finalmente, la Figura \@ref(fig:fss-abi) muestra el FSS calculado comparando la estimación de IMERG con cada experimento para distintos umbrales y escalas espaciales, siendo 10 km igual a la resolución del modelo. En todos los casos RAD+ABI y ABI tienen valores mayores de FSS que RAD que ya mostraba mejoras importantes respecto de SATWND. Solo para el umbral de 25 $mmh^{-1}$ hay un periodo alrededor de las 12 UTC del 22 de noviembre donde todos los análisis que asimilan radianzas no logran representar correctamente la convección y muestran un FSS menor a SATWND. Comparando RAD+ABI y ABI vemos que entre las 06 y las 18 UTC del 22 de noviembre ABI representa la precipitación ligeramente mejor que RAD+ABI, lo que podría indicar que las radianzas de satélites polares tienen un impacto negativo en el análisis. Sin embargo hacia el final del periodo simulado, la relación es opuesta. RAD+ABI tiene valores de FSS mayores que ABI y cercanos a RAD. En la siguiente Sección por lo tanto, se evaluará el impacto de asimilar radianzas en pronósticos a corto plazo y se analizará si el impacto observado en los análisis perdura en los pronósticos y mejora la representación de la convección.

(ref:fss-abi) FSS calculado sobre la precipitación acumulada a 1 hora en una ventana móvil de 6 horas para umbrales de 1 mm (a y c) y 25 mm (b y d), en escalas de 10 km (a y b) y 100 km (c y d), para el campo preliminar de los experimentos SATWND (línea naranja), RAD (línea roja), RAD+ABI (línea verde), y ABI (línea turqueza) entre las 00 UTC del 22 de noviembre y las 12 UTC del 23 de noviembre.

```{r fss-abi, fig.cap="(ref:fss-abi)", fig.width=5, fig.height=5}


fss %>% 
  .[q %in% c(1, 25) & w %in% c(1, 11) & exp %in% c("E6", "E9", "E10", "EG3")] %>% 
  .[, ":="(q_label = factor(q, labels = c("1~mm~h^{-1}", "25~mm~h^{-1}")),
           w_label = factor(w, labels = c("10~km", "100~km")))] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = colores_exp_abi, 
                     labels = c(E6 = "SATWND", E9 = "RAD",
                               E10 = "RAD+ABI", EG3 = "ABI")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  coord_cartesian(xlim = c(ymd_hms(20181122000000), ymd_hms(20181123120000))) +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```


#### Pronósticos determinísticos

```{r}
# files <- Sys.glob(here("data/derived_data/FSS/fss_6h_fcst_det_2018112200*d02.csv"))

files <- Sys.glob("~/datosmunin3/EXP/derived_data/fss_1h_fcst_det_2018112200_*_d02.csv")

fss_det <- map(files, function(f){
  
  meta <- unglue(basename(f), "fss_1h_fcst_det_{ini_date}_{exp}_d02.csv")
  
  fread(f) %>% 
    .[, ini_date := meta[[1]][["ini_date"]]]
}) %>% 
  rbindlist()

fss_det[q %in% c(1, 5, 10) & w %in% c(1, 5) & exp %in% c("E6", "E9", "E10", "EG3", "GFS")] %>% 
    .[, ":="(q_label = factor(q, labels = c("1~mm~h^{-1}",  "5~mm~h^{-1}", "25~mm~h^{-1}")),
           w_label = factor(w, labels = c("2~km", "10~km")))] %>% 
  ggplot(aes(date, fss)) +
  geom_line(aes(color = exp, linetype = ini_date)) +
  scale_color_manual(values = c(colores_exp_abi, GFS = "grey20"),  
                     labels = c(E6 = "SATWND", E9 = "RAD",
                               E10 = "RAD+ABI", EG3 = "ABI")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  coord_cartesian(xlim = c(ymd_hms(20181122000000), ymd_hms(20181123100000))) +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

```{r}
imerg <- read_rds(here("data/derived_data/observations/IMERG_1h.rds"))

q <- c(1, 5, 10, 25, 50)

lon_band = c(-67.7, -53.7)
lat_band = c(-40.5, -21.3)
imerg <- purrr::map(q, function(f){
  
  imerg %>%
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
    .[lon %between% lon_band & lat %between% lat_band] %>%
    .[, .(area = sum(pp_acum > f)/.N), by = .(end_date)] %>%
    .[, umbral := f] %>%
    .[]
}) %>%
  rbindlist()


# files <- Sys.glob("~/datosmunin3/EXP/derived_data/ppacum/E*_fcst_det*area*")
files <- Sys.glob(here("data/derived_data/analysis_variables/pp_area/*_fcst_det*area*"))

pp_area <- purrr::map(files, function(f) {
  
  meta <- unglue(f, "{exp}_fcst_det_{ini}_area_acum_1h.rds")
  
  readRDS(f) %>% 
    .[, ini_date := meta[[1]][["ini"]]]
  
}) %>% rbindlist()

pp_area %>% 
  .[umbral %in% c(1, 5, 10) & exp %in% c("E6", "E9", "E10", "EG3", "GFS")] %>% 
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp, ini_date)] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5, 10)], 
            aes(end_date, area, color = "OBS"),
            linetype = 2) +
  # geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp), alpha = .1) +
  geom_line(aes(color = exp, linetype = ini_date)) +
  scale_color_manual(values = c(OBS = "grey20", colores_exp_abi, GFS = "grey20"),
                     labels = c(E6 = "SATWND", E9 = "RAD",
                                E10 = "RAD+ABI", EG3 = "ABI",
                                GFS = "GFS", OBS = "OBS")) +
  # scale_fill_manual(values = c(OBS = "grey20", colores_exp_abi, GFS = "grey20"),
  #                   guide = NULL,
  #                   labels = c(E6 = "SATWND", E9 = "RAD",
  #                               E10 = "RAD+ABI", EG3 = "ABI",
  #                               GFS = "GFS", OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_wrap(~umbral, scales = "free_y", 
             labeller = labeller(umbral = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"))) +
  tagger::tag_facets() +
  labs(y = "Área cubierta por precipitación (%)", x = NULL, 
       fill = NULL, color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```


## Conclusiones

