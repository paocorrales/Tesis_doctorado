# Impacto de la asimilación de observaciones convencionales, de estaciones automáticas, vientos derivados de satélite y radianzas de satelites polares en pronósticos a corto plazo 

```{r include=FALSE}
map_arg <- rnaturalearth::ne_states(country = c("argentina"), 
                                    returnclass = "sf")
map_limitrofes <- rnaturalearth::ne_countries(country = c("Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

square <- fread(here("data/derived_data/sample_obs/dominio_square.csv"))
square2 <- fread(here("data/derived_data/sample_obs/dominio_square2.csv"))
coord <- fread(here("data/derived_data/sample_obs/coordenadas.csv"))


geom_mapa <- function(fill = NA) {
  list(geom_sf(data = map_arg, fill = fill, color = "black", size = 0.05, inherit.aes = FALSE),
       geom_sf(data = map_limitrofes, fill = fill, color = "black", size = 0.05, inherit.aes = FALSE),
       coord_sf(ylim = c(-42, -19), xlim = c(-76, -51)),
       scale_x_longitude(ticks = 5),
       scale_y_latitude(ticks = 5))
}

arg_topo <- metR::GetTopography(-75+360, -50+360, -20, -60, resolution = 1/10, 
                                file.dir = here("data/derived_data/"))
arg_topo[, lon := metR::ConvertLongitude(lon)]

cordillera <- list(
  ggnewscale::new_scale_fill(),
  geom_contour_fill(data = arg_topo, aes(x = lon, y = lat,
                                         z = h),
                    breaks = seq(1500, 8000, by = 700)),
  scale_fill_gradient(low = "#E2E6E6", high = "#7E7E7E", guide = "none",
                      oob = scales::squish))

scale_date <- function(ini = 20181120180000, end = 20181123120000,
                       break_bin = "6 hour", ...) {
  scale_x_datetime(breaks = seq.POSIXt(ymd_hms(ini), ymd_hms(end), by = break_bin), ..., expand = c(0, 0),
                   labels = function(x) {
                     fifelse(hour(x) == 0, format(x, "%H UTC\n%b %d"), format(x, "%H"))
                   }) 
}

obs.type <- tribble(
  ~type, ~code,
  120, "ADPUPA",
  130, "AIRCFT-AIREP",
  131, "AIRCFT-AMDAR",
  133, "AIRCAR",
  180, "SFCSHP",
  181, "ADPSFC",
  187, "ADPSFC\nno pressure",
  220, "ADPUPA",
  221, "ADPUPA-PIBAL",
  230, "AIRCFT-AIREP",
  231, "AIRCFT-AMDAR",
  233, "AIRCAR",
  280, "SFCSHP",
  281, "ADPSFC",
  287, "ADPSFC\nno pressure",
  290, "ASCATW"
) %>% 
  setDT()


colores_exp <- c(E2 = "#0077BB", E5 = "#88CCEE", E6 = "#EE7733", E9 = "#CC3311")
```


## Metodología

### Configuracion de los experimentos

## Resultados

### Impacto de las observaciones en el pronostico

Al comparar los pronósticos con ERA5, en promedio la temperatura en niveles altos es menor a lo esperado pero no se observan diferencias entre los experimentos o entre las 2 inicializaciones de los pronósticos. Esto sugiere que las condiciones iniciales no afectan particularmente esta variable en niveles altos. En niveles bajos se observa la misma tendencia que en los análisis los pronísticos inicializados a partir de AWS y SATWND muestran un bias cálido mucho menor que CONV gracias a la asimilación de observaciones de EMA. En RAD el bias vuelve a aumentar ligeramente. En niveles bajos si se ven mejoras para la inicialización de las 06 UTC, indicando que las observaciones asimiladas entre las 00 y las 06 UTC tienen un impacto positivo. 

Las comparaciones para la humedad específica muestran nuevamente el bias seco presente en los análisis con una mejora notoria en los pronósticos inicializados a partir de AWS y SATWND y RAD. La inicialización de las 06 UTC no parece ser muy distinta a la primera. 

La mayor diferencia en el viento meridional se observa en niveles altos y está asociado al pediodo de mayor actividad convectiva sobre el norte del dominio. En particular SATWND es el pronóstico que mejor representa el viento meridional, particularmente en el pronóstico inicializado a las 06 UTC. Algo similar se observa en la diferencia para el viento zonal.


**¿Cómo es el campo de viento en esos niveles? y ¿cómo influye en el desarrollo de la convección?**


(ref:era5-fcst-t) Diferencia entre la media del ensamble del pronóstico inicializado a partir de cada experimento y ERA5 de los perfiles verticales promediados espacialmente de la temperatura del aire ($K$) calculado sobre el dominio de validación (cuadro rojo en la Figura \@ref(fig:dominio)a) para cada tiempo de pronóstico.

(ref:era5-fcst-q) Cómo en la Figura \@ref(fig:era5-fcst-1) pero para la humedad específica ($g\ Kg^{-1}$).

(ref:era5-fcst-v) Cómo en la Figura \@ref(fig:era5-fcst-1) pero para el viento meridional ($m\ s^{-1}$).

(ref:era5-fcst-u) Cómo en la Figura \@ref(fig:era5-fcst-1) pero para el viento zonal ($m\ s^{-1}$).

```{r era5-fcst, fig.cap=c("(ref:era5-fcst-t)", "(ref:era5-fcst-q)", "(ref:era5-fcst-v)", "(ref:era5-fcst-u)"), fig.align="center", fig.pos="ht"}

files <- Sys.glob(here("data/derived_data/forecast_variables/perfiles_fcst_E[2569]_201811220*.csv"))

perfiles <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "perfiles_{run}_{exp}_{ini_date}.csv")
  fread(f) %>% 
    .[, exp := mata_exp[[1]][["exp"]]] %>% 
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 

perfiles %>%
  .[variable == "T"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = fcst - era, fill = stat(level)),
                    breaks = seq(-4, 3, 0.5)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 3, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left",
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181122000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = "Temperatura (K)",
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "QVAPOR"] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)),
                    breaks = seq(-0.004, 0.0015, 0.0005)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-0.004, 0.0015, 0.0005)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = latex2exp::TeX("Humedad \nespecífica ($g$ $Kg^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "V"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)), 
                    breaks = seq(-4, 11, 1)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 11, 1)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = latex2exp::TeX("V ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "U"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)), 
                    breaks = seq(-4, 4, 0.5)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 4, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = latex2exp::TeX("U ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

```

### Verificacion de los pronósticos de precipitación

Para cuantificar la habilidad de los pronósticos para predecir la precipitación se calculó el FSS para los pronósticos por ensambles en ventanas móviles de 6 horas para los mismos umbrales y escalas espaciales usados para la precipitación acumulada horaria del first guess (Figura \@ref(fig:fssfcst)). Los pronósticos de CONV generan valores muy bajos de FSS en comparación con los experimentos que incluyen otras fuentes de observaciones. AWS, SATWND y RAD muestran mejoras en los valores de FSS, especialmente para el umbral más alto (Figura \@ref(fig:fssfcst)b, d). Además, la inicialización de las 06 UTC obtiene mejores resultados para AWS, SATWND y RAD que el pronóstico inicializado a las 00 UTC, lo que pone de relieve el impacto positivo de las observaciones asimiladas entre las 00 y las 06 UTC. 

Las observaciones de viento derivadas de satélite muestran un impacto claramente positivo en el pronóstico, a diferencia de lo que se observó al comparar el pronóstico de 1 hora con observaciones independientes en términos de precipitación. Por el contrario, las radiancias tuvieron un impacto entre neutro y ligeramente negativo en el pronóstico, a diferencia de lo que se observó al comparar el pronóstico de 1 hora con las estimaciones del IMERG. **El motivo por el que los pronósticos inicializados a partir de RAD se degradan con el tiempo debe estudiarse más a fondo.** Sin embargo, es posible que la asimilación de observaciones asociadas a canales afectados por la superficie esté contribuyendo a la degradación de la PBL en el análisis y, posteriormente, en los pronósticos. @lim2014 observó un impacto limitado al asimilar las observaciones de AIRS y atribuye este resultado al uso de canales superficiales en los que las incertidumbres asociadas a la emisividad son grandes. 


(ref:fssfcst) FSS calculado sobre la precipitación acumulada a 1 hora en una ventana móvil de 6 horas para umbrales de 1 mm (a y c) y 25 mm (b y d), en escalas de 10 km (a y b) y 100 km (c y d), para los pronósticos inicializados a partir de los experimentos CONV (línea azul), AWS (línea celeste), SATWND (línea naranja) y RAD (línea roja) a las 00 UTC (línea sólida) y 06 UTC (linea punteada) del 22 de noviembre.


```{r fssfcst, fig.cap="(ref:fssfcst)", fig.width=5, fig.height=5}
files <- Sys.glob(here("data/derived_data/FSS/fss_6h_fcst_ens_*_E[2569]_ens.csv"))

fss <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "fss_6h_fcst_ens_{ini_date}_{exp}_ens.csv")
  
  fread(f) %>% 
    .[, date := as_datetime(date)] %>% 
    .[, ini_date := ymd_h(meta[[1]][["ini_date"]])]
}) %>% 
  rbindlist()

fss %>% 
  .[q %in% c(1, 25) & w %in% c(1, 11)] %>% 
  .[, ":="(q_label = factor(q, labels = c("1~mm~h^{-1}", "25~mm~h^{-1}")),
           w_label = factor(w, labels = c("10~km", "100~km")))] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT",
                                                      E6 = "SATWND", E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018-11-22 00:00:00" = "OO UTC", 
                                                     "2018-11-22 06:00:00" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

El porcentaje de área cubierta por precipitación mayor a determinados umbrales muestra una importante subestimación de la precipitación media. El área sombreada que muestra el área máxima calculada sobre todo el ensamble se acerca un poco más a lo observado pero en general y sobre todo para umbrales de pp bajos, se adelanta en el tiempo. Los pronósticos inicializados a partir de CONV subestiman el área cubierta por precipitación durante el periodo más activio y luego la sobreestima durante el 23 de noviembre. 

(ref:area) Porcentaje de área cubierta por precipitación superior a $1 mmh^{-1}$ (a y c) y $5 mmh^{-1}$ (b y d) a lo largo del tiempo para los pronósticos inicializados a partir de los experimentos CONV (línea azul), AWS (línea celeste), SATWND (línea naranja) y RAD (línea roja) a las 00 UTC (línea sólida) y 06 UTC (linea punteada) del 22 de noviembre. En línea continua negra se muetra la estimación de IMERG. 

```{r area, fig.cap="(ref:area)", fig.width=6, fig.height=5}

imerg <- read_rds(here("data/derived_data/observations/IMERG_1h.rds"))

q <- c(1, 5, 10, 25, 50)
lon_band = c(-66.5, -61.5)
lat_band = c(-35.5, -29)
imerg <- purrr::map(q, function(f){
  
  imerg %>%
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
    .[lon %between% lon_band & lat %between% lat_band] %>%
    .[, .(area = sum(pp_acum > f)/.N), by = .(end_date)] %>%
    .[, umbral := f] %>%
    .[]
}) %>%
  rbindlist() 


files <- Sys.glob(here("data/derived_data/forecast_variables/ppacum/E[2569]_fcst_*_area_acum_1h.rds"))

pp_area <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "{exp}_fcst_{ini_date}_area_acum_1h.rds")
  
  readRDS(f) %>% 
    .[, ":="(ini_date = ymd_h(meta[[1]][["ini_date"]]))]
  
}) %>% rbindlist()

pp_area %>% 
  .[umbral %in% c(1, 5) ] %>%
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp, ini_date)] %>% 
  .[, ":="(q_label = factor(umbral, labels = c("1~mm~h^{-1}", "5~mm~h^{-1}")),
           date_label = factor(ini_date, labels = c("00~UTC", "06~UTC")))] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5)] %>% 
              .[, q_label := factor(umbral, labels = c("1~mm~h^{-1}", "5~mm~h^{-1}"))], 
            aes(end_date, area, color = "OBS"),
            linetype = 1) +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp, group = interaction(exp, ini_date)), alpha = .1) +
  scale_color_manual(values = c(OBS = "grey20", colores_exp),
                     labels =  c(E2 = "CONV", E5 = "ASWS", E6 = "SATWND",
                                 E9 = "RAD", OBS = "IMERG")) +
  scale_fill_manual(values = c(OBS = "grey20", colores_exp),
                    guide = NULL,
                    labels = c(E2 = "CONV", E5 = "ASWS", E6 = "SATWND",
                               E9 = "RAD", OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018-11-22 00:00:00" = "00 UTC", 
                                                     "2018-11-22 06:00:00" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_grid(date_label~q_label, scales = "free_y", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(y = "Área cubierta por precipitación (%)", x = NULL, 
       fill = NULL, color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

00 UTC
Los pronósticos sobreestiman la ocurrencia de precipitación para los percentiles más bajos (asociados a menor precipitación). Para humbrales más altos/percentiles mayores los pronósticos subestiman la ocurrencia de precipitación, esto es coherente con lo que se ve con el FSS. Como la pendiente es casi siempre positiva, los pronósticos son "confiables"

06 UTC
Subestiman la ocurrencia de precipitación para probabilidades bajas y la sobreestiman para probabilidades altas. Cuando los pronósticos indican una probabilidad de ocurrencia muy alta, la frecuencia observada es muy baja por lo que el pronóstico deja de ser confiable. 

(ref:reliability00) Diagrama de confiabilidad calculado sobre el pronóstico inicializado a las 00UTC para probabilidades pronósticadas 0, 20, 40, 60, 80 y 100% de ocurrencia de precipitación acumulada en 3 horas mayor al percentil a) 0.95, b) 0.97, c) 0.99 y d) 0.9925. Los subplots muestran la frecuencia relativa de eventos (x 100.000) asociada a cada intervalo de probabilidad para cada percentil. 

(ref:reliability06) Cómo en la Figura \@ref(fig:reliability-1) pero pera el pronóstico inicializado a las 06 UTC

```{r reliability, fig.cap=c("(ref:reliability00)", "(ref:reliability06)"), fig.align="center", fig.width=5}

# cut2 <- function (x, breaks) 
# {
#   # labels <- na.omit((breaks + data.table::shift(breaks, -1))/2)
#   cuts <- cut(x, breaks = breaks, labels = breaks[-1], include.lowest = TRUE)
#   as.numeric(as.character(cuts))
# }
# 
# files <- Sys.glob(here("~/datosmunin3/EXP/derived_data/ppacum/E[2,5,6,9]_fcst_*_quant_acum_3h.rds"))
# 
# pp_wrf <- purrr::map(files, function(f) {
#   mata_exp <- unglue(basename(f), "{exp}_{run}_{ini_date}_quant_acum_3h.rds")
#   read_rds(f) %>% 
#     # .[, exp := mata_exp[[1]][["exp"]]] %>% 
#     .[, ini_date := mata_exp[[1]][["ini_date"]]]
#   
# }) %>% 
#   rbindlist() 
# 
# 
# pp_wrf[, prop_interval2 := cut2(prop, breaks = seq(-0.2, 1, 0.2))]
# 
# pp_imerg <- read_rds("~/datosmunin3/EXP/derived_data/IMERG_3h.rds")
# 
# prop <- pp_imerg[pp_wrf, on = c("x", "y", "end_date" = "date")] %>% 
#   .[, obs_bin := as.numeric(pp_acum >= umbral)] 
# 
# prop <- prop %>% 
#   .[end_date %between% c(ymd_hms(20181122000000), ymd_hms(20181123120000)) & umbral %in% c(0.95, 0.97, 0.99, 0.9925)] %>%
#   .[, .(freq_obs = sum(obs_bin)/.N), by = .(exp, ini_date, umbral, prop_interval2)] %>% 
#   .[, percentil := paste0("Percentil ", umbral)] 
# 
# write_rds(prop, "~/datosmunin3/EXP/paper_ana_20181122-derived_data/forecast_variables/ppacum/prop_percentiles_pp.rds")

# n_freq <- prop %>% 
#     .[end_date %between% c(ymd_hms(20181122000000), ymd_hms(20181123120000)) & 
#         umbral %in% c(0.95, 0.97, 0.99, 0.9925), .N, by = .(umbral, prop_interval2, exp, ini_date)]
# 
# write_rds(n_freq, "~/datosmunin3/EXP/paper_ana_20181122-derived_data/forecast_variables/ppacum/n_freq_percentiles_pp.rds")

n_freq <- read_rds(here("data/derived_data/forecast_variables/ppacum/n_freq_percentiles_pp.rds"))

prop <- read_rds(here("data/derived_data/forecast_variables/ppacum/prop_percentiles_pp.rds"))

subplots <- map(c(0.95, 0.97, 0.99, 0.9925), function(u) {
  n_freq %>% 
    .[ini_date == "2018112200"] %>% 
    ggplot(aes(prop_interval2, N/100000)) +
    geom_col(aes(fill = exp), position = "dodge") +
    scale_fill_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                       E6 = "SATWND", E9 = "RAD"), guide = "none") +
    scale_x_continuous(breaks = seq(0, 1, 0.2), expand = c(0,0)) +
    # scale_y_log10() +
    labs(color = NULL, x = NULL, y = NULL) +
    theme_minimal(base_size = 9) +
    theme(panel.background = element_rect(fill = "#fbfbfb", color = NA),
          plot.background = element_rect(fill = "white", color = NA))
})

subplots_df <- tibble(percentil = paste0("Percentil ", c(0.95, 0.97, 0.99, 0.9925)), subplot = subplots)

prop %>% 
  .[ini_date == "2018112200" & umbral %in% c(0.95, 0.97, 0.99, 0.9925)] %>%
  ggplot(aes(prop_interval2, freq_obs)) +
  geom_abline(slope = 1, intercept = 0, color = "darkgrey") +
  geom_point(aes(color = exp)) +
  geom_line(aes(color = exp)) +
  ggpp::geom_plot_npc(data = subplots_df, aes(label = subplot), npcx = 0.95, npcy = 0.05, vp.width = 0.6) +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ percentil, ncol = 2) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = "Probabilidad pronosticada", y = "Frecuencia relativa observada") +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

subplots <- map(c(0.95, 0.97, 0.99, 0.9925), function(u) {
  n_freq %>% 
    .[ini_date == "2018112206"] %>% 
    ggplot(aes(prop_interval2, N/100000)) +
    geom_col(aes(fill = exp), position = "dodge") +
    scale_fill_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                       E6 = "SATWND", E9 = "RAD"), guide = "none") +
    scale_x_continuous(breaks = seq(0, 1, 0.2), expand = c(0,0)) +
    # scale_y_log10() +
    labs(color = NULL, x = NULL, y = NULL) +
    theme_minimal(base_size = 9) +
    theme(panel.background = element_rect(fill = "#fbfbfb", color = NA),
          plot.background = element_rect(fill = "white", color = NA))
})

subplots_df <- tibble(percentil = paste0("Percentil ", c(0.95, 0.97, 0.99, 0.9925)), subplot = subplots)

prop %>% 
  .[ini_date == "2018112206" & umbral %in% c(0.95, 0.97, 0.99, 0.9925)] %>%
  ggplot(aes(prop_interval2, freq_obs)) +
  geom_abline(slope = 1, intercept = 0, color = "darkgrey") +
  geom_point(aes(color = exp)) +
  geom_line(aes(color = exp)) +
  ggpp::geom_plot_npc(data = subplots_df, aes(label = subplot), npcx = 0.95, npcy = 0.05, vp.width = 0.6) +
  scale_x_continuous(breaks = seq(0, 1, 0.2)) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ percentil, ncol = 2) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = "Probabilidad pronosticada", y = "Frecuencia relativa observada") +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```




```{r}
quantiles <- fread(here("data/derived_data/forecast_variables/ppacum/quantiles_fcst_3h.csv")) %>% 
  .[quantile %in% c(0.95, 0.97, 0.99, 0.9925)] %>% 
  .[, value := round(value, 2)] %>% 
  dcast(exp + ini_date ~ quantile) %>% 
  .[, ":="(exp = fcase(exp == "E2", "CONV",
                       exp == "E5", "AWS",
                       exp == "E6", "SATWND",
                       exp == "E9", "RAD"),
           ini_date = fifelse(ini_date == ymd_hms(20181122000000), "00 UTC", "06 UTC"))] %>% 
  arrange(ini_date)

quantiles %>% 
  kbl(booktabs = TRUE, col.names = c("Experimento", "Pronóstico", "0.95", "0.97", "0.99", "0.9925"),
      caption = "Valor de la precipitación acumulada en 3 hs asociada a distintos percentiles calculados para cada inicialización de pronóstico y cada experimento.") %>% 
  kable_classic_2() %>% 
  collapse_rows(columns = 2) 


```


La probabilidad de pp mayor a 10 mm en un periodo de 30 hs, muestra que la pp se genera más al norter y al oeste de lo observado. Los pronósticos tardan en generar precipitación abundante al comienzo.

Entre las 2 inicializaciones se ve una clara difirencia, la probabilidad de pricipitación para los disitntos umbrales en 06 UTC es mayor y si bien tiene un corrimiento al oeste en la región norte (es decir cuando la convección está mas concentrada en el norte del pais) ocupa una región similar a la pp observada. 

SATWND tiene probabilidades mayores a los otros pronósticos. 

(ref:prob) Probabilidad de ocurrencia de precipitación acumulada en 30 hs superior a 10 mm (fila 1 y 2) y 50 mm (fila 3 y 4) para los pronósticos inicializados a las 00 y 06 UTC a partir de cada experimento. 

```{r prob, fig.cap="(ref:prob)", fig.width=6, fig.height=7, fig.align="center"}
files <- Sys.glob(here("data/derived_data/forecast_variables/ppacum/E[2,5,6,9]_fcst_*_prop_acum_30h.rds"))

pp_wrf <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "{exp}_{run}_{ini_date}_prop_acum_30h.rds")
  read_rds(f) %>% 
    .[, exp := mata_exp[[1]][["exp"]]] %>%
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 

pp_imerg <- read_rds(here("data/derived_data/observations/IMERG_1h.rds"))

pp_imerg <- rbind(pp_imerg[end_date %between% c(ymd_hms(20181122010000), ymd_hms(20181123060000)),
                           .(pp_acum = sum(pp_acum),
                             ini_date = "2018112200"), by = .(x, y)],
                  
                  pp_imerg[end_date %between% c(ymd_hms(20181122070000), ymd_hms(20181123120000)),
                           .(pp_acum = sum(pp_acum),
                             ini_date = "2018112206"), by = .(x, y)] 
)

colors_smooth_rainbow <- c("#E8ECFB", "#B997C7", "#824D99", "#4E78C4", "#57A2AC", "#7EB875", "#D0B541",
                           "#E67F33", "#CE2220", "#521A13")

pp_wrf[umbral %in% c(10, 50) & prop > 0.09] %>% 
  .[, prop := prop + abs(rnorm(.N, sd = 0.0000000001))] %>%
  .[, prop := scales::rescale(prop, to = c(0, 1))] %>% 
  # .[, .(umbral_label = factor(umbral, labels = c("10~mm~h^{-1}", "50~mm~h^{-1}")))] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = prop, fill = ..level..),
                    proj = norargentina_lambert) +
  scale_fill_manual(values = colors_smooth_rainbow, guide = guide_colorsteps(barwidth = 20,
                                                                             barheight = 0.3,
                                                                             title.position = "left", 
                                                                             title.vjust = 1,
                                                                             frame.colour = "black")) +
  geom_contour2(data = pp_imerg, aes(z = pp_acum), color = "black",
                breaks = 10,
                proj = norargentina_lambert) +
  geom_mapa() +
  facet_grid(umbral + ini_date ~ exp, 
             labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                         E6 = "SATWND", E9 = "RAD"),
                                 ini_date = c(`2018112200` = "00 UTC",
                                              `2018112206` = "06 UTC"),
                                 umbral = c(`10` = "10 mmh-1",
                                            `50` = "50 mmh-1"))) +
  labs(fill = "Probabilidad") + 
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom")

```

### Análisis y verificación por parametrizaciones

Comparación con las observaciones de EMA durante el periodo. 

Humedad y temperatura: la diferencia principal entre las inicializaciones está en el BIAS, el error de los pronósticos tiene una componente sistemática importante. 06 UTC arranca mejor en términos de bias, no se ve mucha mejora en el RMSE. CONV mantiene un bias y rmse mayor respecto de los otros experimentos. El resto mantiene la tendencia vista en los análisis y comparación con ERA5

**¿Se ve por cuanto tiempo perdura la mejora?**

Para el viento zonal, no se ve muchas diferencias entre las inicializaciones o los experimentos al comienzo. Aunque hacia la mitad de 22 de noviembre se ve que 06 UTC tiene mayor bias y rmse. 

Viento meridional, 06 UTC arranca mejor respecto del RMSE y eso se mantiene por al menos 6 horas.

(ref:aut-all) RMSE (línea sólida) y Bias (línea discontinua) de a) humedad especifica ($g\ Kg{^-1}$), b) temperatura ($K$), c) el viento u ($m\ s^{-1}$) y d) el viento v ($m\ s^{-1}$) calculados comparando los pronósticos de cada experimento con las observaciones de EMA. La línea azul corresponde a CONV, la línea celeste a AWS, SATWND se representa con una línea naranja y RAD con una línea roja.

```{r rmse-bias-aut, fig.cap="(ref:aut-all)", fig.align="centern", fig.width=6, fig.height=3}
fisica <- data.table(mem = as.character(formatC(1:60, flag = "0", width = 3)),
                     fisica = rep(c("KF-YSU", 
                                    "BMJ-YSU",
                                    "GF-YSU",
                                    "KF-MYJ",
                                    "BMJ-MYJ",
                                    "GF-MYJ",
                                    "KF-MYNN2",
                                    "BMJ-MYNN2",
                                    "GF-MYNN2"), length.out = 60)) %>% setDT()

media <- rbind(read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112200_mean_new.rds")),
               read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112206_mean_new.rds"))) %>% 
  .[, ":="(RMSE = fifelse(var == "q", RMSE*1000, RMSE),
           BIAS = fifelse(var == "q", BIAS*1000, BIAS))] %>% 
  .[, BIAS := -BIAS]

hline <- data.frame(estadistinco = rep(c("RMSE", "BIAS"), each = 4),
                    var = rep(c("t", "q", "u", "v"), 2),
                    value =  rep(c(NA, 0), each = 4))


media %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico") %>% 
  .[, ":="(estadistico_label = factor(estadistico),
           var_label = factor(var, labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                              "Temperatura~(K)",
                                              "Viento~U~(m~s^{-1})",
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(date, value)) +
  geom_hline(data = hline, aes(yintercept = value), color = "darkgrey") +
  geom_line(aes(color = exp, linetype = fcst_exp)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS", 
                                                      E6 = "SATWND", E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018112200" = "00 UTC", 
                                                     "2018112206" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours", 
             limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  labs(x = NULL, y = NULL, linetype = NULL, color = NULL) +
  facet_grid(estadistico_label ~ var_label, scales = "free_y", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        aspect.ratio = 1/1.5,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```
(ref:aut-all) RMSE y BIAS calculados comparando los pronósticos con observaciones de EMA y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de capa límite MYJ (círculo), MYNN2 (triángulo) e YSU (cuadrado) para todos los pronósticos en conjunto. 

```{r aut-all, fig.cap="(ref:aut-all)", fig.align="center", fig.width=7, fig.height=4}
miembros <- rbind(read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112200_mem_new.rds")),
                  read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112206_mem_new.rds"))) %>% 
  .[, ":="(RMSE = fifelse(var == "q", RMSE*1000, RMSE),
           BIAS = fifelse(var == "q", BIAS*1000, BIAS))] %>% 
  .[, BIAS := -BIAS]

pbl <- fisica[miembros, on = .NATURAL] %>% 
  separate(fisica, into = c("cumulus", "pbl")) %>% 
  .[, .(BIAS = mean(BIAS),
        RMSE = mean(RMSE)), by = .(exp, fcst_exp, pbl, var, date)] %>% 
  setnames("pbl", "param") %>% 
  .[, tipo := "pbl"]

pbl %>% 
  .[, .(RMSE = mean(RMSE, na.rm = TRUE),
        BIAS = mean(BIAS, na.rm = TRUE)), 
    by = .(var, exp, param, tipo)] %>% 
  .[var != "u"] %>% 
  melt(id.vars = c("exp", "param", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  .[, ":="(variable_label = factor(variable),
           var_label = factor(var, labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                              "Temperatura~(K)", 
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(value, exp)) +
  geom_point(aes(color = exp, shape = param),
             size = 3) +
  scale_color_manual(guide = NULL, values = colores_exp, 
                     labels = c(E2 = "CONV", E5 = "AUT", 
                                E6 = "SATWND", E9 = "RAD")) +
  scale_shape_manual(values = c(19, 17, 15, 3, 0, 8)) +
  scale_y_discrete(labels = c(E2 = "CONV", E5 = "AWS", 
                              E6 = "SATWND", E9 = "RAD")) +
  facet_grid(var_label ~ variable_label, scales = "free",   
             labeller = label_parsed) +
  labs(y = NULL, x = NULL, shape = NULL) +
  tagger::tag_facets(position = list(x = 0.03, y = 0.95)) +
  theme_minimal(base_size = 9) +
  theme(aspect.ratio = 1/2,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

(ref:aut-rad) RMSE y BIAS calculados comparando los pronósticos con observaciones de EMA y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de capa límite MYJ (línea llena), MYNN2 (línea a rayas) e YSU (línea punteada) para todos los pronósticos en conjunto a lo largo del tiempo de pronóstico. 

```{r aut-rad, fig.cap="(ref:aut-rad)", fig.align="center", fig.width=6, fig.height=3}
pbl %>% 
  melt(id.vars = c("exp", "param", "fcst_exp", "date", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  .[exp == "E9" & fcst_exp == "2018112200"] %>% 
  ggplot(aes(date, value)) +
  # geom_hline(yintercept = 0, color = "darkgrey") +
  geom_line(aes(color = exp, linetype = param)) +
  scale_color_manual(values = colores_exp[4], labels = c(E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2, 3)) +
  scale_date(20181122000000, 20181123000000, "12 hours", 
             limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  labs(x = NULL, y = NULL, linetype = NULL, color = NULL) +
  facet_grid(variable ~ var, scales = "free_y", 
             labeller = labeller(var = c("q" = "Humedad\n específica (g/kg)",
                                         "t" = "Temperatura (K)",
                                         "u" = "Viento zonal (m/s)",
                                         "v" = "Viento\n meridional (m/s)"))) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  theme_minimal() +
  theme(aspect.ratio = 1/1.5,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```
(ref:soundings-fcst) RMSE (línea sólida) y Bias (línea discontinua) de a) la temperatura ($K$), b) la temperatura del punto de rocío ($K$), c) el viento u ($m\ s^{-1}$) y d) el viento v ($m\ s^{-1}$) calculados comparando el análisis de cada experimento con los sondeos de RELAMPAGO durante el IOP 7 y el IOP 8. La línea azul corresponde a CONV, la línea celeste a AWS, SATWND se representa con una línea naranja y RAD con una línea roja.

```{r soundings-fcst, fig.cap="(ref:soundings-fcst)", fig.width=6, fig.height=4, fig.align="center"}
media <- read_rds(here("data/derived_data/soundings/sondeos_media_fcst.rds")) %>% 
  .[, .(RMSE = sqrt(mean((fcst_value - value)^2, na.rm = TRUE)), 
        BIAS = mean(fcst_value - value, na.rm = TRUE)), 
    by = .(exp, variable, lev, fcst_exp)] %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico", value.name = "value.est")

media %>% 
  .[, ":="(fcst_exp_label = factor(fcst_exp, labels = c("00~UTC", "06~UTC")),
           variable_labels = factor(variable, labels = c("Temperatura~(K)", "atop('Temperatura de', 'punto de rocío (K)')", "Viento~U~(m~s^{-1})", "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(lev/1000, value.est)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = estadistico)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_flip(xlim = c(0, 15)) +
  facet_grid(fcst_exp_label ~ variable_labels, scales = "free_x", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.95)) +
  labs(y = "Bias/RMSE", x = "Altura (Km)", color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

(ref:soudings-all) RMSE y BIAS calculados comparando los pronósticos con sondeos de RELAMPAGO y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de convección BMJ (círculo), GF (triángulo) e KF (cuadrado) para todos los pronósticos en conjunto. 

```{r soudings-all, fig.cap="(ref:soudings-all)", fig.align="center", fig.width=7, fig.height=4}

miembros <- read_rds(here("data/derived_data/soundings/sondeos_agregados_fcst.rds")) %>% 
  .[, mem := formatC(mem, width = 3, flag = "0")] %>% 
  fisica[., on = "mem"] %>% 
  separate(fisica, into = c("cumulus", "pbl")) %>% 
  setDT() %>% 
  .[, BIAS := -BIAS]

cum <- miembros[, .(RMSE = mean(RMSE),
                    BIAS = mean(BIAS),
                    tipo = "cumulus"), 
                by = .(exp, fcst_exp, cumulus, lev, variable)] %>% 
  setnames(c("cumulus", "variable"), c("param", "var"))

cum %>% 
  .[, .(RMSE = mean(RMSE, na.rm = TRUE),
        BIAS = mean(BIAS, na.rm = TRUE)), 
    by = .(var, exp, param, tipo)] %>% 
  .[var != "u"] %>% 
  melt(id.vars = c("exp", "param", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
    .[, ":="(variable_label = factor(variable),
           var_label = factor(var, labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                              "Temperatura~(K)", 
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(value, exp)) +
  # geom_vline(xintercept = 0, color = "grey70") +
  geom_point(aes(color = exp, shape = param),
             size = 3) +
  scale_color_manual(guide = NULL, values = colores_exp, 
                     labels = c(E2 = "CONV", E5 = "AUT", 
                                E6 = "SATWND", E9 = "RAD")) +
  scale_shape_manual(values = c(19, 17, 15, 3, 0, 8)) +
  scale_y_discrete(labels = c(E2 = "CONV", E5 = "AUT", 
                              E6 = "SATWND", E9 = "RAD")) +
  facet_grid(var_label ~ variable_label, scales = "free", labeller = label_parsed) +
  labs(y = NULL, x = NULL, shape = NULL) +
  tagger::tag_facets(position = list(x = 0.03, y = 0.95)) +
  theme_minimal(base_size = 9) +
  theme(aspect.ratio = 1/2,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```
(ref:souding-rad) RMSE y BIAS calculados comparando los pronósticos con observaciones de sondeos de RELAMPAGO y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de conveccón BMJ (línea llena), GF (línea a rayas) e KF (línea punteada) para todos los pronósticos en conjunto. 

```{r souding-rad, fig.cap="(ref:souding-rad)", fig.width=6, fig.height=4, fig.align="center"}
cum %>% 
  .[exp == "E9" & fcst_exp == 2018112200] %>% 
  melt(measure.vars = c("RMSE", "BIAS")) %>% 
      .[, ":="(variable_label = factor(variable),
           var_label = factor(var, labels = c("Temperatura~(K)", 
                                              "atop('Temperatura de', 'punto de rocío (K)')", 
                                              "Viento~U~(m~s^{-1})", 
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(lev/1000, value)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = param, group = interaction(exp, param))) +
  scale_linetype_manual(values = c(1, 2, 3)) +
  scale_color_manual(values = colores_exp[4], labels = c(E9 = "RAD")) +
  coord_flip(xlim = c(0, 15)) +
  facet_grid(variable_label ~ var_label, scales = "free", labeller = label_parsed) +
  labs(y = NULL, x = NULL, linetype = NULL, color = NULL) +
  tagger::tag_facets(position = list(x = 0.03, y = 0.95)) +
  theme_minimal() +
  theme(aspect.ratio = 1,
                legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```


## Conclusiones
