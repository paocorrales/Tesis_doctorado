# Impacto de la asimilación de observaciones convencionales, de estaciones automáticas, vientos derivados de satélite y radianzas de satelites polares en pronósticos a corto plazo 

En este capítulo se evaluará en impacto de la asimilación de distintas fuentes de observación en pronósticos por ensable a corto plazo inicializados a partir del análisis de los distintos experimentos descriptos en la Sección \@ref(config). Estos pronósticos abarcan el periodo de iniciación, madurez y dearrollo del SCM observado durante el 22 y 23 de noviembre de 2022. Otros autores estudiaron los pronósticos generados a partir de sistemas de asimilación regionales, por ejemplo @jones2014 evaluaron pronósticos de eventos de precipitación utilizando condiciones iniciales generadas incluyendo asimilación de observaciones de radar y radianzas infrarrojas sintéticas. Encontraron que la combinación de estas fuentes de observación generaban el mayor impacto y en particular, que las observaciones del canal 6.95 $\mu m$ mejoraban la representación de la humedad en niveles medios. Sin embargo el impacto en los pronósticos no perduraba más allá de las 3 horas. Por otro lado, @bao2015 estudiaron el impacto de la asimilación de observaciones convencionales y radianzas de satelites con sensores de microondas e infrarrojo sobre la temperatura y humedad pronosticadas para distintas capas de la atmósfera sobre un dominio regional en Estados Unidos. Observaron una disminición del RMSE de la temperatura en la tropósfera alta y la estratósfera baja gracias a observaciones de microondas pero un impacto negativo asociados a las observaciones de IASI. El bias asociado a la humedad disminuyó con la asimilación de observaciones satelitales, en particular de infrarrojo en toda la tropósfera. 

Muchos trabajos utilizan ensambles multifísica para capturar la incertidumbre en los modelos y al mismo tiempo evaluar el impacto de la asimilación en los pronósticos. @dillon2021 aplicaron la misma combinación de parametrizaciones que usan los experimentos de este trabajo y encontraron que las combinaciones de parametrizaciones que mejor representan las variables en superficie como temperatura y humedad a 2 metros eran distintas a las combinaciones que lograban el mejor pronóstico de precipitación. En muchos otros trabajos donde se utiliza este enfoque, no se hace un análisis por parametrizaciones ya que los resultados pueden depender furtemente del caso de estudio, de la región o de los fenónemos involucrados. 

Por lo tanto se analizará el impacto de la asimilación de observaciones para la generación de los pronósticos en un contexto de convección húmeda profunda y se evaluará si las mejoras observadas en los análisis al respresentar este caso de estudio se trasladan a los pronósticos. En particular se hará foco en la representación de la temperatura y humedad en la tropósfera para evaluar el entorno en el cual se desarrolla la convección y en el viento meridional para analizar el desplazamiento del frente frío asociado al SCM. Para evaluar la intensidad del SCM estudiaremos la precipitación generada por los pronósticos evaluando tanto la ubicación como su intensidad. 

## Metodología

### Configuracion de los experimentos

Para estudiar el impacto de la asimilación de observaciones en pronósticos independientes, se generaron pronósticos por ensambles inicializados a partir de los análisis de los experimentos previamente descriptos. Estos pronósticos toman el nombre del análisis que utilizan como condición inicial, por ejemplo el pronóstico CONV será aquel que fue incializado a partir del análisis del experimento CONV. Todos los pronósticos utilizan la misma configuración de dominio y de ensamble multifísica que los análisis. Las condiciones de borde de los miembros del ensamble se generaron añadiendo perturbaciones aleatorias al pronóstico determinístico del GFS (0.25$^{\circ}$ de resolución horizontal y resolución temporal de 6 horas; @cisl_rda_ds084.1) como se muestra en la Figura \@ref(fig:cycle-fcst). Estas perturbaciones son las mismas que se utilizaron la para generación de las condiciones de borde de los análisis.

Los pronósticos se inicializaron a las 00 y 06 UTC del 22 de noviembre para capturar la inicialización y desarrollo del SCM y además evaluar las posibles diferencias entre los experimentos debido a la asimilación de nuevas observaciones entre las 00 y las 06 UTC. Todos los pronósticos finalizan a las 12 UTC del 23 de noviembre cuando el SCM se encuentra en el borde noroeste del dominio (Figura \@ref(fig:caso)f). 


(ref:cycle-fcst) Diagrama de los pronósticos por ensambles inicializados a las 00 y 06 UTC del 22 de noviembre y que se extienden hasta las 12 UTC del 23 de noviembre. Las condiciones de borde corresponden al pronóstico de GFS y se incorporan cada 6 horas.

```{r cycle-fcst, echo=FALSE, fig.cap="(ref:cycle-fcst)", out.width="100%"}

knitr::include_graphics(here("figure/forecast_diag.png"))

```

## Resultados

### Impacto de las observaciones en el pronostico {#prono-impacto}

Al igual que en la Sección \@ref(impacto-analisis), se compararon los pronósticos con ERA5 sobre la región definida en la Figura \@ref(fig:dominio). La diferencia entre los perfiles de temperatura de la media del ensamble promediados espacialmente y ERA5 a lo largo del tiempo se muestran en las Figuras \@ref(fig:era5-fcst-1). En lineas generales la temperatura por encima de 750 hPa es subestimada por los pronósticos y esto ocurre independientemente de las condiciones iniciales que se utilicen. Sin embargo, y al igual que en los análisis, se observa una mejor representación de la temperatura por encima de 750 hPa cuando las condiciones iniciales incluyen observaciones de EMA. En niveles bajos se observa la misma tendencia que en los análisis, los pronósticos inicializados a partir de AWS y SATWND muestran un bias cálido mucho menor que CONV gracias a las condiciones iniciales que incluyen la asimilación de observaciones de EMA. En RAD el bias cálido vuelve a aumentar ligeramente manteniendo la tendencia observada en los análisis de RAD (Figuras \@ref(fig:era5-fcst-1)d y h). Es importante notar que el impacto que genera la asimilación de las distintas fuentes de observación persiste en los pronósticos. La persistencia del bias cálido en la capa límite podría indicar que los errores en el modelo contribuyen a este error. En la capa límite sí se ven diferencias entre las dos inicializaciones, en particular se observan mejoras para la inicialización de las 06 UTC en los casos de AWS y SATWND, indicando que las observaciones asimiladas entre las 00 y las 06 UTC tienen un impacto positivo en la representación de la temperatura cerca de superficie que se traslada a los pronósticos. 

Las diferencias entre los pronósticos y ERA5 para los perfiles promediados de humedad específica (Figuras \@ref(fig:era5-fcst-2)) muestran nuevamente el bias seco presente en el modelo y que es más importante en horas nocturnas. Sin embargo es notaria la mejora en los pronósticos inicializados a partir de AWS y SATWND y RAD, en comparación con CONV. Los pronósticos inicializados a partir de CONV mantienen un bias seco muy marcado a lo largo de todo el periodo y que nuevamente puede estar asociado con errores sistemáticos en el modelo (Figuras \@ref(fig:era5-fcst-2)a y e). Las dos inicialización, en este caso, no muestran diferencias apreciables.


(ref:era5-fcst-t) Diferencia entre la media del ensamble del pronóstico inicializado a partir de cada experimento y ERA5 de los perfiles verticales promediados espacialmente de la temperatura del aire ($K$) calculado sobre el dominio de validación (cuadro rojo en la Figura \@ref(fig:dominio)a) para cada tiempo de pronóstico.

(ref:era5-fcst-q) Cómo en la Figura \@ref(fig:era5-fcst-1) pero para la humedad específica ($g\ Kg^{-1}$).

(ref:era5-fcst-v) Cómo en la Figura \@ref(fig:era5-fcst-1) pero para el viento meridional ($m\ s^{-1}$).

(ref:era5-fcst-u) Cómo en la Figura \@ref(fig:era5-fcst-1) pero para el viento zonal ($m\ s^{-1}$).

```{r era5-fcst, fig.cap=c("(ref:era5-fcst-t)", "(ref:era5-fcst-q)", "(ref:era5-fcst-v)", "(ref:era5-fcst-u)"), fig.align="center", fig.pos="ht"}

files <- Sys.glob(here("data/derived_data/forecast_variables/perfiles_fcst_E[2569]_201811220*.csv"))

perfiles <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "perfiles_{run}_{exp}_{ini_date}.csv")
  fread(f) %>% 
    .[, exp := mata_exp[[1]][["exp"]]] %>% 
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 

perfiles %>%
  .[variable == "T"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = fcst - era, fill = stat(level)),
                    breaks = seq(-4, 3, 0.5)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 3, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left",
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181122000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = "Temperatura (K)",
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "QVAPOR"] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)),
                    breaks = seq(-0.004, 0.0015, 0.0005)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-0.004, 0.0015, 0.0005)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = latex2exp::TeX("Humedad \nespecífica ($g$ $Kg^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "V"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)), 
                    breaks = seq(-4, 11, 1)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 11, 1)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = latex2exp::TeX("V ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "U"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)), 
                    breaks = seq(-4, 4, 0.5)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 4, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Presión (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"),
                                                 ini_date = c(`2018112200` = "00 UTC",
                                                              `2018112206` = "06 UTC"))) +
  labs(fill = latex2exp::TeX("U ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Presión (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

```
Es interesante notar que la asimilación de radianzas que aportan información en niveles medios y altos, también produce un impacto en niveles bajos de la atmósfera. Es posible que el desarrollo nuboso que se ve influenciado por cambios de temperatura y humedad genera también cambios en la temperatura en superficie.  En este caso las mayores temperaturas observadas en los pronósticos de RAD se pueden explicar por una disminución en el desarrollo de nubes (no se muestra).

La mayor diferencia en los perfiles promediados para el viento meridional se observa en niveles altos y está asociado al periodo de mayor actividad convectiva sobre el norte del dominio (Figuras \@ref(fig:era5-fcst-3)). En particular SATWND es el pronóstico que mejor representa el viento meridional, particularmente en el pronóstico inicializado a las 06 UTC (Figura \@ref(fig:era5-fcst-3)g). Esto es particularmente intererante ya que el impacto de las observaciones de viento derivadas de satélite asimiladas en el experimento SATWND era marginal comparado al impacto de otra fuentes de observaciones. Sin embargo los pronósticos inicializados con condiciones inciales que incluye información de viento derivado de satélite representan mejor el viento meridional aún en los periodos de mayor convección. Si se analizan los experimentos individualmente alrededor de las 00 UTC del 23 de noviembre, se observa que SATWND presenta mayor convergencia en niveles bajos y mayor divergencia en niveles altos cuando se lo compara con RAD (no se muestra). Esto podría indica que la convección en SATWND es más intensa.

Algo similar se observa en la diferencia entre perfiles vericales del viento zonal en las Figuras \@ref(fig:era5-fcst-3). Los pronósticos inicializados a partir de los experimentos AWS, SATWND y RAD muestran una mejor representación del viento zonal en todos los niveles. Sin embargo las observaciones de satelites polares parecen generar un impacto negativo en las condiciones iniciales de RAD que se traslada al pronóstico aumentando la diferencia respecto de ERA5. 

XXXXX agregar propagación de condiciones de borde e iniciales XXXXXXXXXXx

### Verificacion de los pronósticos de precipitación

Para cuantificar la habilidad de los pronósticos en distintos plazos al representar la precipitación se calculó el FSS a partir de los pronósticos por ensambles en ventanas móviles de 6 horas para los mismos umbrales y escalas espaciales usados para la precipitación acumulada horaria del campo preliminar en la Sección \@ref(#val-analisis) (Figura \@ref(fig:fssfcst)). Los pronósticos de CONV generan valores muy bajos de FSS en comparación con los experimentos que incluyen otras fuentes de observaciones lo que indica una subestimación de la precipitación en todas las escalas. AWS, SATWND y RAD muestran mejoras en los valores de FSS, especialmente para el umbral de 25 mm (Figura \@ref(fig:fssfcst)b, d). Además, la inicialización de las 06 UTC muestra mejores resultados en todos los experimentos que los pronósticos inicializados a las 00 UTC, lo que pone de relieve el impacto positivo de las observaciones asimiladas entre las 00 y las 06 UTC en la representación de la precipitación como así también la incorporación de condiciones de borde provenientes del GFSF. 

Las observaciones de viento derivadas de satélite muestran un impacto claramente positivo en los pronósticos, a diferencia de lo que se observó al comparar el pronóstico a 1 hora con observaciones independientes en la verificación de los análisis. Esto evidencia el desarrollo de convección más intensa y es coherente con lo analizado en la Sección \@ref(prono-impacto) Por el contrario, las radiancias tuvieron un impacto neutro a ligeramente negativo en los pronósticos inicializados a las 00 y 06 UTC particularmente en los umbrales altos de precipitación. Si bien existen muchos posibles motivos por el que los pronósticos inicializados a partir de RAD se degradan con el tiempo, es posible que la asimilación de observaciones asociadas a canales afectados por la superficie contribuya a la degradación de la capa límite en el análisis y, posteriormente, en los pronósticos. Por ejemplo, @lim2014 observó un impacto limitado al asimilar las observaciones de AIRS y atribuye este resultado al uso de canales superficiales en los que las incertidumbres asociadas a la emisividad de la superficie son grandes. 


(ref:fssfcst) FSS calculado sobre la precipitación acumulada a 1 hora en una ventana móvil de 6 horas para umbrales de 1 mm (a y c) y 25 mm (b y d), en escalas de 10 km (a y b) y 100 km (c y d), para los pronósticos inicializados a partir de los experimentos CONV (línea azul), AWS (línea celeste), SATWND (línea naranja) y RAD (línea roja) a las 00 UTC (línea sólida) y 06 UTC (linea punteada) del 22 de noviembre.


```{r fssfcst, fig.cap="(ref:fssfcst)", fig.width=5, fig.height=5}
files <- Sys.glob(here("data/derived_data/FSS/fss_6h_fcst_ens_*_E[2569]_ens.csv"))

fss <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "fss_6h_fcst_ens_{ini_date}_{exp}_ens.csv")
  
  fread(f) %>% 
    .[, date := as_datetime(date)] %>% 
    .[, ini_date := ymd_h(meta[[1]][["ini_date"]])] 
}) %>% 
  rbindlist()



fss %>% 
  .[q %in% c(1, 25) & w %in% c(1, 11)] %>% 
  .[, ":="(q_label = factor(q, labels = c("1~mm~h^{-1}", "25~mm~h^{-1}")),
           w_label = factor(w, labels = c("10~km", "100~km")))] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT",
                                                      E6 = "SATWND", E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018-11-22 00:00:00" = "OO UTC", 
                                                     "2018-11-22 06:00:00" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```


El porcentaje de área cubierta por precipitación superior a determinados umbrales se muestra en la Figura \@ref(fig:area). Nuevamente, los pronósticos muestran una importante subestimación de la precipitación media, en particular CONV. El área sombreada que muestra el área máxima estimada sobre todos los miembros del ensamble se acerca al área estimada por IMERG, sin embargo todos los experimentos y sobre todo en el umbral de 1 $mmh^{-1}$, la precipitación se adelantan en el tiempo. En este sentido, RAD es el experimento que mejor representa la precipitación respecto de su inicialización. Los pronósticos inicializados a partir de CONV subestiman el área cubierta por precipitación durante el periodo más activo y luego la sobreestiman durante el 23 de noviembre cuando ya no se observa precipitación intensa dentro del dominio de estudio. 

(ref:area) Porcentaje de área cubierta por precipitación superior a 1 $mmh^{-1}$ (a y c) y 5 $mmh^{-1}$ (b y d) a lo largo del tiempo para los pronósticos inicializados a partir de los experimentos CONV (línea azul), AWS (línea celeste), SATWND (línea naranja) y RAD (línea roja) a las 00 UTC (línea sólida) y 06 UTC (linea punteada) del 22 de noviembre. En sombreado y para cada experimento se muestra el área máxima y mínima estimada por el ensamble de pronósticos. En línea continua negra se muetra la estimación de IMERG. 

```{r area, fig.cap="(ref:area)", fig.width=6, fig.height=5}

imerg <- read_rds(here("data/derived_data/observations/IMERG_1h.rds"))

q <- c(1, 5, 10, 25, 50)
lon_band = c(-66.5, -61.5)
lat_band = c(-35.5, -29)
imerg <- purrr::map(q, function(f){
  
  imerg %>%
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
    .[lon %between% lon_band & lat %between% lat_band] %>%
    .[, .(area = sum(pp_acum > f)/.N), by = .(end_date)] %>%
    .[, umbral := f] %>%
    .[]
}) %>%
  rbindlist() 


files <- Sys.glob(here("data/derived_data/forecast_variables/ppacum/E[2569]_fcst_*_area_acum_1h.rds"))

pp_area <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "{exp}_fcst_{ini_date}_area_acum_1h.rds")
  
  readRDS(f) %>% 
    .[, ":="(ini_date = ymd_h(meta[[1]][["ini_date"]]))]
  
}) %>% rbindlist()

pp_area %>% 
  .[umbral %in% c(1, 5) ] %>%
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp, ini_date)] %>% 
  .[, ":="(q_label = factor(umbral, labels = c("1~mm~h^{-1}", "5~mm~h^{-1}")),
           date_label = factor(ini_date, labels = c("atop('00 UTC')", "atop('06 UTC')")))] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5)] %>% 
              .[, q_label := factor(umbral, labels = c("1~mm~h^{-1}", "5~mm~h^{-1}"))], 
            aes(end_date, area, color = "OBS"),
            linetype = 1) +
  geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp, group = interaction(exp, ini_date)), alpha = .1) +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  scale_color_manual(values = c(OBS = "grey20", colores_exp),
                     labels =  c(E2 = "CONV", E5 = "ASWS", E6 = "SATWND",
                                 E9 = "RAD", OBS = "IMERG")) +
  scale_fill_manual(values = c(OBS = "grey20", colores_exp),
                    guide = NULL,
                    labels = c(E2 = "CONV", E5 = "ASWS", E6 = "SATWND",
                               E9 = "RAD", OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018-11-22 00:00:00" = "00 UTC", 
                                                     "2018-11-22 06:00:00" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_grid(date_label~q_label, scales = "free_y", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(y = "Área cubierta por precipitación (%)", x = NULL, 
       fill = NULL, color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

Los pronósticos por ensambles permiten obtener información probabilistica al calcular, por ejemplo, la proporción de miembros del ensamblen que pronostican precipitación en un determinado lugar. Para evaluar el pronóstico de precipitación desde el punto de vista probabilístico, se generaron diagramas de confiabilidad usando probabilidades pronósticadas de 0, 20, 40, 60, 80 y 100% calculadas sobre el ensamble para los pronósticos inicializados a las 00 UTC (Figuras \@ref(fig:reliability-1)) y 06 UTC (Figuras \@ref(fig:reliability-2)) utilizando percentiles de precipitación calculados sobre todo el periodo pronosticado (Tabla \@ref(tab:quantiles)). En un diagrama de confiabilidad, la línea diagonal representa un pronóstico totalmente confiable. Por el contrario, pronósticos por debajo de la diagonal sobreestiman la probabilidad ocurrencia del evento observado y pronósticos por encima de la diagonal, subestiman la probabilidad ocurrencia del evento. Debido a que los pronósticos generados subestiman fuertemente la precipitación, trabajamos con percentiles. Esto tiene la ventaja de permitir una mejor comparación de los resultados en terminos de los percentiles. Al mismo tiempo el percentil 0.99, por ejemplo, representará umbrales de precipitación distintos para cada experimento (Tabla \@ref(tab:quantiles)) y dificulta hacer un análisis de eventos extremos.

Los pronósticos inicializados a las 00 UTC muestran curvas de confiabilidad con tendencia positiva, por lo que son considerados confiables. Sin embargo, para probabilidades de precipitación hasta 60%, los pronósticos subestiman la ocurrencia de precipitación. Esta subestimación aumenta a medida que aumenta el percentil (Figuras \@ref(fig:reliability-1)c-d), lo que indica nuevamente que los pronósticos subestiman la ocurrencia de precipitación muy intensa. En probabilidades del ensamble superiores al 60%, los pronósticos sobreestiman la ocurrencia de precipitación cuando se observan los primeros percentiles (umbrales bajos) o son incapaces de producir estos valores de probabilidad cuando se observan umbrales altos de precipitación. Esto se ve muy claramente en los gráficos de frecuencia relativa de eventos que acompañan cada diagrama de confiabilidad, donde la frecuencia de eventos con probabilidades por encima de 60% es baja o nula.  

Los pronósticos inicializados a las 06 UTC muestran tendencias similares, sin embargo es notorio como los umbrales de precipitación asociados a cada percentil, que se muestran en la Tabla \@ref(tab:quantiles), aumentan considerablemente respecto de los pronósticos de las 00 UTC. Es posible que las condiciones iniciales que incluyen nuevas observaciones en conjunto con condiciones de borde actualizadas de GFSF favorezcan un aumento en el desarrollo de la precipitación. 

En líneas generales todos los experimentos muestran un comportamiento similar con muy pequeñas diferencias principalmente en el percentil 0.95. Para algunas probabilidades pronósticadas el experimento CONV se observa más cercano a la diagonal, es decir, es más confiable. Sin embargo esto ocurre solo para umbrales pequeños de precipitación ya que subestima umbrales más altos (Figura \@ref(fig:fssfcst)) como así tambien, el área cubierta por precipitación (Figura \@ref(fig:area))

(ref:reliability00) Diagrama de confiabilidad calculado sobre el pronóstico inicializado a las 00 UTC para probabilidades de 0, 20, 40, 60, 80 y 100% de ocurrencia de precipitación acumulada en 3 horas mayor al percentil a) 0.95, b) 0.97, c) 0.99 y d) 0.9925. Los gráficos secundarios dentro de cada diagrama muestran la frecuencia relativa de eventos (x 100.000) asociada a cada intervalo de probabilidad para cada percentil. 

(ref:reliability06) Cómo en la Figura \@ref(fig:reliability-1) pero pera el pronóstico inicializado a las 06 UTC

```{r reliability, fig.cap=c("(ref:reliability00)", "(ref:reliability06)"), fig.align="center", fig.width=5}

# cut2 <- function (x, breaks) 
# {
#   # labels <- na.omit((breaks + data.table::shift(breaks, -1))/2)
#   cuts <- cut(x, breaks = breaks, labels = breaks[-1], include.lowest = TRUE)
#   as.numeric(as.character(cuts))
# }
# 
# files <- Sys.glob(here("~/datosmunin3/EXP/derived_data/ppacum/E[2,5,6,9]_fcst_*_quant_acum_3h.rds"))
# 
# pp_wrf <- purrr::map(files, function(f) {
#   mata_exp <- unglue(basename(f), "{exp}_{run}_{ini_date}_quant_acum_3h.rds")
#   read_rds(f) %>% 
#     # .[, exp := mata_exp[[1]][["exp"]]] %>% 
#     .[, ini_date := mata_exp[[1]][["ini_date"]]]
#   
# }) %>% 
#   rbindlist() 
# 
# 
# pp_wrf[, prop_interval2 := cut2(prop, breaks = seq(-0.2, 1, 0.2))]
# 
# pp_imerg <- read_rds("~/datosmunin3/EXP/derived_data/IMERG_3h.rds")
# 
# prop <- pp_imerg[pp_wrf, on = c("x", "y", "end_date" = "date")] %>% 
#   .[, obs_bin := as.numeric(pp_acum >= umbral)] 
# 
# prop <- prop %>% 
#   .[end_date %between% c(ymd_hms(20181122000000), ymd_hms(20181123120000)) & umbral %in% c(0.95, 0.97, 0.99, 0.9925)] %>%
#   .[, .(freq_obs = sum(obs_bin)/.N), by = .(exp, ini_date, umbral, prop_interval2)] %>% 
#   .[, percentil := paste0("Percentil ", umbral)] 
# 
# write_rds(prop, "~/datosmunin3/EXP/paper_ana_20181122-derived_data/forecast_variables/ppacum/prop_percentiles_pp.rds")

# n_freq <- prop %>% 
#     .[end_date %between% c(ymd_hms(20181122000000), ymd_hms(20181123120000)) & 
#         umbral %in% c(0.95, 0.97, 0.99, 0.9925), .N, by = .(umbral, prop_interval2, exp, ini_date)]
# 
# write_rds(n_freq, "~/datosmunin3/EXP/paper_ana_20181122-derived_data/forecast_variables/ppacum/n_freq_percentiles_pp.rds")

n_freq <- read_rds(here("data/derived_data/forecast_variables/ppacum/n_freq_percentiles_pp.rds"))

prop <- read_rds(here("data/derived_data/forecast_variables/ppacum/prop_percentiles_pp.rds"))

subplots <- map(c(0.95, 0.97, 0.99, 0.9925), function(u) {
  n_freq %>% 
    .[ini_date == "2018112200"] %>% 
    ggplot(aes(prop_interval2*100, N/100000)) +
    geom_col(aes(fill = exp), position = "dodge") +
    scale_fill_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                       E6 = "SATWND", E9 = "RAD"), guide = "none") +
    scale_x_continuous(breaks = seq(0, 100, 20), expand = c(0,0)) +
    # scale_y_log10() +
    labs(color = NULL, x = NULL, y = NULL) +
    theme_minimal(base_size = 9) +
    theme(panel.background = element_rect(fill = "#fbfbfb", color = NA),
          plot.background = element_rect(fill = "white", color = NA))
})

subplots_df <- tibble(percentil = paste0("Percentil ", c(0.95, 0.97, 0.99, 0.9925)), subplot = subplots)

prop %>% 
  .[ini_date == "2018112200" & umbral %in% c(0.95, 0.97, 0.99, 0.9925)] %>%
  ggplot(aes(prop_interval2, freq_obs)) +
  geom_abline(slope = 1, intercept = 0, color = "darkgrey") +
  geom_point(aes(color = exp)) +
  geom_line(aes(color = exp)) +
  ggpp::geom_plot_npc(data = subplots_df, aes(label = subplot), npcx = 0.95, npcy = 0.05, vp.width = 0.6) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ percentil, ncol = 2) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = "Probabilidad pronosticada", y = "Frecuencia relativa observada") +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        legend.box.margin = margin(0, 0, 0, 0),
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

subplots <- map(c(0.95, 0.97, 0.99, 0.9925), function(u) {
  n_freq %>% 
    .[ini_date == "2018112206"] %>% 
    ggplot(aes(prop_interval2*100, N/100000)) +
    geom_col(aes(fill = exp), position = "dodge") +
    scale_fill_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                       E6 = "SATWND", E9 = "RAD"), guide = "none") +
    scale_x_continuous(breaks = seq(0, 100, 20), expand = c(0,0)) +
    # scale_y_log10() +
    labs(color = NULL, x = NULL, y = NULL) +
    theme_minimal(base_size = 9) +
    theme(panel.background = element_rect(fill = "#fbfbfb", color = NA),
          plot.background = element_rect(fill = "white", color = NA))
})

subplots_df <- tibble(percentil = paste0("Percentil ", c(0.95, 0.97, 0.99, 0.9925)), subplot = subplots)

prop %>% 
  .[ini_date == "2018112206" & umbral %in% c(0.95, 0.97, 0.99, 0.9925)] %>%
  ggplot(aes(prop_interval2, freq_obs)) +
  geom_abline(slope = 1, intercept = 0, color = "darkgrey") +
  geom_point(aes(color = exp)) +
  geom_line(aes(color = exp)) +
  ggpp::geom_plot_npc(data = subplots_df, aes(label = subplot), npcx = 0.95, npcy = 0.05, vp.width = 0.6) +
  scale_x_continuous(breaks = seq(0, 1, 0.2), labels = scales::percent) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS",
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ percentil, ncol = 2) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  labs(color = NULL, x = "Probabilidad pronosticada", y = "Frecuencia relativa observada") +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```




```{r quantiles}
quantiles <- fread(here("data/derived_data/forecast_variables/ppacum/quantiles_fcst_3h.csv")) %>% 
  .[quantile %in% c(0.95, 0.97, 0.99, 0.9925)] %>% 
  .[, value := round(value, 2)] %>% 
  dcast(exp + ini_date ~ quantile) %>% 
  .[, ":="(exp = fcase(exp == "E2", "CONV",
                       exp == "E5", "AWS",
                       exp == "E6", "SATWND",
                       exp == "E9", "RAD"),
           ini_date = fifelse(ini_date == ymd_hms(20181122000000), "00 UTC", "06 UTC"))] %>% 
  arrange(ini_date)

quantiles %>% 
  kbl(booktabs = TRUE, col.names = c("Experimento", "Pronóstico", "0.95", "0.97", "0.99", "0.9925"),
      caption = "Valor de la precipitación acumulada en 3 hs asociada a distintos percentiles calculados para cada inicialización de pronóstico y cada experimento.") %>% 
  kable_styling(font_size = 10,
                position = "center") %>% 
  kable_classic_2() %>% 
  collapse_rows(columns = 2) 


```

Finalmente las Figuras \@ref(fig:prob) muestran la probabilidad de ocurrencia de precipitaición acumulada en 36 hs para los pronósticos inicializados a las 00 UTC y 30 hs para los pronósticos inicializados a las 06 UTC; para distintos umbrales de precipitación.

Los campos de probabilidad de precipitación mayor a 10 mm (Figuras \@ref(fig:prob)a-h), muestra que la precipitación se genera más hacia el norte y oeste de lo observado (línea negra). Al igual que en los análisis (Figura \@ref(fig:pp-hov)), los pronósticos no son capaces de representar correctamente la precipitación en la región sur del dominio. Esto también se observa en la Figura \@ref(fig:fssfcst) donde se ve que los valores de FSS van aumentando en las primeras horas de pronóstico, es decir, la precipitación se acerca a lo observado tanto en magnitud como en localización. Sin embargo, es notoria la mejora que se produce en los experimentos que se generaron a partir de condiciones iniciales con asimilación de EMA y vientos derivados de satélite respecto de CONV. Los pronósticos RAD si bien son mejores que CONV, subestiman la intensidad de la precipitación en mayor medida que SATWND. 

Las Figuras \@ref(fig:prob)i-p muestran los campos de probabilidad de precipitación superior a 50 mm donde se puede apreciar una vez más como los pronósticos subestiman la precipitación, en particular para los umbrales más altos. Al igual que para el umbral de 10 mm, es interesante notar la mejora que se produce entre las inicializaciones. 06 UTC logra representar mucho mejor la distribución de precipitación en el dominio que los pronósticos de las 00 UTC. Por ejemplo, el pronóstico SATWND de las 06 UTC (Figura \@ref(fig:prob)o) captura casi la totalidad del área de precipitación observada, aunque solo en un 10% de los miembros del ensamble. 

(ref:prob) Probabilidad de ocurrencia de precipitación acumulada en 36 y 30 hs superior a 10 mm (fila 1 y 2) y 50 mm (fila 3 y 4) para los pronósticos inicializados a las 00 y 06 UTC respectivamente. 

```{r prob, fig.cap="(ref:prob)", fig.width=6, fig.height=7, fig.align="center"}
files <- Sys.glob(here("data/derived_data/forecast_variables/ppacum/E[2,5,6,9]_fcst_*_prop_acum_30h.rds"))

pp_wrf <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "{exp}_{run}_{ini_date}_prop_acum_30h.rds")
  read_rds(f) %>% 
    .[, exp := mata_exp[[1]][["exp"]]] %>%
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 

pp_imerg <- read_rds(here("data/derived_data/observations/IMERG_1h.rds"))

pp_imerg <- rbind(pp_imerg[end_date %between% c(ymd_hms(20181122010000), ymd_hms(20181123120000)),
                           .(pp_acum = sum(pp_acum),
                             ini_date = "2018112200"), by = .(x, y)],
                  
                  pp_imerg[end_date %between% c(ymd_hms(20181122070000), ymd_hms(20181123120000)),
                           .(pp_acum = sum(pp_acum),
                             ini_date = "2018112206"), by = .(x, y)] 
)

colors_smooth_rainbow <- c("#E8ECFB", "#B997C7", "#824D99", "#4E78C4", "#57A2AC", "#7EB875", "#D0B541",
                           "#E67F33", "#CE2220", "#521A13")

pp_wrf[umbral %in% c(10, 50) & prop > 0.09] %>% 
  .[, prop := prop + abs(rnorm(.N, sd = 0.0000000001))] %>%
  .[, prop := scales::rescale(prop, to = c(0, 1))] %>% 
  na.omit() %>% 
  # .[, .(umbral_label = factor(umbral, labels = c("10~mm~h^{-1}", "50~mm~h^{-1}")))] %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = prop, fill = ..level..),
                    proj = norargentina_lambert) +
  scale_fill_manual(values = colors_smooth_rainbow, guide = guide_colorsteps(barwidth = 20,
                                                                             barheight = 0.3,
                                                                             title.position = "left", 
                                                                             title.vjust = 1,
                                                                             frame.colour = "black")) +
  geom_contour2(data = copy(pp_imerg)[, umbral := 10], aes(z = pp_acum), color = "black",
                breaks = 10,
                proj = norargentina_lambert) +
  geom_contour2(data = copy(pp_imerg)[, umbral := 50], aes(z = pp_acum), color = "black",
                breaks = 50,
                proj = norargentina_lambert) +
  geom_mapa() +
  ggh4x::facet_nested(umbral + ini_date ~ exp, 
                      labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                  E6 = "SATWND", E9 = "RAD"),
                                          ini_date = c(`2018112200` = "00 UTC",
                                                       `2018112206` = "06 UTC"),
                                          umbral = c(`10` = "10 mm",
                                                     `50` = "50 mm"))) +
  tagger::tag_facets() +
  labs(fill = "Probabilidad") + 
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom")

```

### Análisis y verificación por parametrizaciones

En esta sección evaluamos los pronósticos de manera cuantitatva comparándolos con observaciones de EMA, que si bien son asimiladas en los experimentos de análisis, son observaciones independietes para los pronósticos y radiosondeos de la campaña RELAMPAGO. 

En primer lugar se calculó el RMSE y BIAS respecto de las observaciones de EMA a lo largo del tiempo para cada pronóstico e inicialización. El BIAS y RMSE de la humedad específica (Figuras \@ref(fig:rmse-bias-aut)a y e) al comienzo de los pronósticos es coherente con las condiciones iniciales. Por ejemplo el BIAS seco asociado a CONV es mucho más importante que el los pronósticos inicializados a partir de AWS. También se observan mejoras en la inicialización de las 06 UTC, algo que no era evidente en  en la comparacion con ERA5 (Figura \@ref(fig:era5-fcst-2)). Los errores asociados a la temperatura (Figuras \@ref(fig:rmse-bias-aut)b y f) son muy dependientes del momento del día, con un aumento del RMSE y del BIAS cálido durante las horas nocturnas. Los pronósticos CONV y RAD para la inicialización de las 06 UTC tienen un mejor densempeño en las primeras horas de pronóstico pero luego se degradan más rápidamente que AWS o SATWND. 

Mientras que no hay características sobresalientes en los errores del viento zonal, en el viento meridional (Figuras \@ref(fig:rmse-bias-aut)d y h), es interesante notar que el RMSE de los pronósticos de las 06 UTC es más bajo que para los pronósticos de las 00 UTC y esta mejora se mantiene por al menos 6 horas. Esto también ocurre en el BIAS aunque en menor medida. 

(ref:aut-bias-aut) Evolución del RMSE y Bias de a) humedad especifica ($g\ Kg{^-1}$), b) temperatura ($K$), c) el viento u ($m\ s^{-1}$) y d) el viento v ($m\ s^{-1}$) calculados comparando los pronósticos de cada experimento con las observaciones de EMA. La línea azul corresponde a CONV, la línea celeste a AWS, SATWND se representa con una línea naranja y RAD con una línea roja. El pronóstico inicializado a las 00 UTC se muestra en línea sólida y el pronóstico de las 06 UTC en línea discontinua.

```{r rmse-bias-aut, fig.cap="(ref:aut-bias-aut)", fig.align="centern", fig.width=6, fig.height=3}
fisica <- data.table(mem = as.character(formatC(1:60, flag = "0", width = 3)),
                     fisica = rep(c("KF-YSU", 
                                    "BMJ-YSU",
                                    "GF-YSU",
                                    "KF-MYJ",
                                    "BMJ-MYJ",
                                    "GF-MYJ",
                                    "KF-MYNN2",
                                    "BMJ-MYNN2",
                                    "GF-MYNN2"), length.out = 60)) %>% setDT()

media <- rbind(read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112200_mean_new.rds")),
               read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112206_mean_new.rds"))) %>% 
  .[, ":="(RMSE = fifelse(var == "q", RMSE*1000, RMSE),
           BIAS = fifelse(var == "q", BIAS*1000, BIAS))] %>% 
  .[, BIAS := -BIAS]

hline <- data.frame(estadistico_label = factor("BIAS"),
                    var_label = factor(c("t", "q", "u", "v"), 
                                       labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                                  "Temperatura~(K)",
                                                  "Viento~U~(m~s^{-1})",
                                                  "Viento~V~(m~s^{-1})")),
                    value =  0)



media %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico") %>% 
  .[, ":="(estadistico_label = factor(estadistico),
           var_label = factor(var, labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                              "Temperatura~(K)",
                                              "Viento~U~(m~s^{-1})",
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(date, value)) +
  geom_hline(data = hline, aes(yintercept = value), color = "darkgrey") +
  geom_line(aes(color = exp, linetype = fcst_exp)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AWS", 
                                                      E6 = "SATWND", E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018112200" = "00 UTC", 
                                                     "2018112206" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours", 
             limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  labs(x = NULL, y = NULL, linetype = NULL, color = NULL) +
  facet_grid(estadistico_label ~ var_label, scales = "free_y", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        aspect.ratio = 1/1.5,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```
La Figura \@ref(fig:aut-all) muestra el RMSE y BIAS calculado comparando con las observaciones de EMA sobre los miembros del ensamble que utilizan cada una de las parametrizaciones de capa límite. En este caso no se muestran las dos inicializaciones por separado ya que ambos pronósticos presentan tendencias muy similares. 

Si bien sería deseable encontrar una parametrización de capa límite que represente correctamente todas las variables de interés, estudios previos (por ejemplo @ruiz2010 y @dillon2021) mostraron que distintas parametrizaciones logran representar correctamente algunas variables pero no todas y que esto puede ser dependiente del caso de estudio. Para esta situación, la parametrización MYJ presenta un menor RMSE y BIAS para las variables termodinámicas (humedad relativa y temperatura) mientras que MYNN2 representa mejor el viento. Sin embargo, a exepción del RMSE del viento, los errores tienen una variabilidad pequeña por lo que la elección de una parametrización u otra podría no tener un impacto importante en la representación de la capa límite. Esto refuerza la necesidad de generar un ensamble multifísica como el utilizado en este trabajo para poder capturar los posibles errores asociados al modelo y la representación de los procesos parametrizados. 

(ref:aut-all) RMSE y BIAS calculados comparando los pronósticos con observaciones de EMA y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de capa límite MYJ (círculo), MYNN2 (triángulo) e YSU (cuadrado) para todos los pronósticos en conjunto. 

```{r aut-all, fig.cap="(ref:aut-all)", fig.align="center", fig.width=7, fig.height=4}
miembros <- rbind(read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112200_mem_new.rds")),
                  read_rds(here("data/derived_data/forecast_variables/interp_obs_2018112206_mem_new.rds"))) %>% 
  .[, ":="(RMSE = fifelse(var == "q", RMSE*1000, RMSE),
           BIAS = fifelse(var == "q", BIAS*1000, BIAS))] %>% 
  .[, BIAS := -BIAS]

pbl <- fisica[miembros, on = .NATURAL] %>% 
  separate(fisica, into = c("cumulus", "pbl")) %>% 
  .[, .(BIAS = mean(BIAS),
        RMSE = mean(RMSE)), by = .(exp, fcst_exp, pbl, var, date)] %>% 
  setnames("pbl", "param") %>% 
  .[, tipo := "pbl"]

vline <- data.frame(variable_label = factor("BIAS"),
                    var_label = factor(c("t", "q", "v"), 
                                       labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                                  "Temperatura~(K)",
                                                  "Viento~V~(m~s^{-1})")),
                    value =  0)


pbl %>% 
  .[, .(RMSE = mean(RMSE, na.rm = TRUE),
        BIAS = mean(BIAS, na.rm = TRUE)), 
    by = .(var, exp, param, tipo)] %>% 
  .[var != "u"] %>% 
  melt(id.vars = c("exp", "param", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  .[, ":="(variable_label = factor(variable),
           var_label = factor(var, labels = c("atop('Humedad', 'específica (g Kg'^-1*')')",
                                              "Temperatura~(K)", 
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(value, exp)) +
  geom_vline(data = vline, aes(xintercept = value), color = "darkgrey") +
  geom_point(aes(color = exp, shape = param),
             size = 3) +
  scale_color_manual(guide = NULL, values = colores_exp, 
                     labels = c(E2 = "CONV", E5 = "AUT", 
                                E6 = "SATWND", E9 = "RAD")) +
  scale_shape_manual(values = c(19, 17, 15, 3, 0, 8)) +
  scale_y_discrete(labels = c(E2 = "CONV", E5 = "AWS", 
                              E6 = "SATWND", E9 = "RAD")) +
  facet_grid(var_label ~ variable_label, scales = "free",   
             labeller = label_parsed) +
  labs(y = NULL, x = NULL, shape = NULL) +
  tagger::tag_facets(position = list(x = 0.03, y = 0.95)) +
  theme_minimal(base_size = 9) +
  theme(aspect.ratio = 1/2,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

Si se analiza los errores asociados a las parametrizaciones de capa límite a lo largo del periodo pronosticado (Figurs \@ref(fig:aut-rad)), en este caso solo para el experimento RAD, la tendencia observada previamente se mantiene. Más importante aún, los errores de ninguna de las parametrizaciones aumenta por sobre el resto, indicando que tienen un comportamiento consistente a lo largo de las 30 y 36 hs de pronóstico. 

(ref:aut-rad) RMSE y BIAS calculados comparando los pronósticos con observaciones de EMA y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de capa límite MYJ (línea llena), MYNN2 (línea a rayas) e YSU (línea punteada) para todos los pronósticos en conjunto a lo largo del tiempo de pronóstico. 

```{r aut-rad, fig.cap="(ref:aut-rad)", fig.align="center", fig.width=6, fig.height=3}
pbl %>% 
  melt(id.vars = c("exp", "param", "fcst_exp", "date", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  .[exp == "E9" & fcst_exp == "2018112200"] %>% 
  ggplot(aes(date, value)) +
   geom_hline(data = hline, aes(yintercept = value), color = "darkgrey") +
  geom_line(aes(color = exp, linetype = param)) +
  scale_color_manual(values = colores_exp[4], labels = c(E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2, 3)) +
  scale_date(20181122000000, 20181123000000, "12 hours", 
             limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  labs(x = NULL, y = NULL, linetype = NULL, color = NULL) +
  facet_grid(variable ~ var, scales = "free_y", 
             labeller = labeller(var = c("q" = "Humedad\n específica (g/kg)",
                                         "t" = "Temperatura (K)",
                                         "u" = "Viento zonal (m/s)",
                                         "v" = "Viento\n meridional (m/s)"))) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.90)) +
  theme_minimal() +
  theme(aspect.ratio = 1/1.5,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```
La Figura \@ref(fig:soundings-fcst) muestra el RMSE y BIAS calculado comparando los pronósticos con los radiosondeos disponibles durante el periodo pronósticado. En líneas generales no se observan grandes diferencias entre las dos inicializaciones. Si bien los pronósticos de las 06 UTC utilizan condiciones iniciales que incluyen información actualizada del entorno, la mayoría de los radiosondeos fueron lanzados en un área muy pequeña en el centro del dominio (Figura \@ref(fig:dominio)b) que podría no haber sido particularmente influenciada por la asimilación de nuevas observaciones. 

Es interesante comparar en este punto los errores asociados a los pronósticos con los errores observados en el análisis (Figura \@ref(fig:fss)e-h). En general, el rango de valores que toma el RMSE y BIAS para cada variable es similar tanto en los pronósticos como en los análisis, lo que indica que los pronósticos logran representar adecuadamente la situacición en esa región del dominio. Sin embargo, también se observa que los errores son muy parecidos entre experimentos cuando se los compara con los errores de los análisis, por lo que es posible que los errores del modelo y las condiciones de borde, iguales para todos los experimentos, tengan una influencia mayor que las condiciones iniciales de cada pronóstico. 

En esta comparación, la característica sobresaliente es la disminución del RMSE y BIAS en niveles bajos en casi todas las variables pero particularmente el viento meridional. El aumento de los errores en los análisis puede atribuirse a la asimilación de observaciones de EMA, que si bien en general producen impactos muy positivos en la representación de la capa límite (comparando la Figura \@ref(fig:soundings-fcst) con la Figura \@ref(fig:era5)), en esta región limitada parece generar el efecto contrario. En los pronósticos independiente, sin asimilación continua de estas observaciones, los errores en niveles bajos disminuyen a valores cercanos a los observados en los análisis de CONV. 

(ref:soundings-fcst) RMSE (línea sólida) y Bias (línea discontinua) de a) la temperatura ($K$), b) la temperatura del punto de rocío ($K$), c) el viento u ($m\ s^{-1}$) y d) el viento v ($m\ s^{-1}$) calculados comparando los pronósticos de cada experimento con los sondeos operativos y de RELAMPAGO. La línea azul corresponde a CONV, la línea celeste a AWS, SATWND se representa con una línea naranja y RAD con una línea roja.

```{r soundings-fcst, fig.cap="(ref:soundings-fcst)", fig.width=6, fig.height=4, fig.align="center"}
media <- read_rds(here("data/derived_data/soundings/sondeos_media_fcst.rds")) %>% 
  .[, .(RMSE = sqrt(mean((fcst_value - value)^2, na.rm = TRUE)), 
        BIAS = mean(fcst_value - value, na.rm = TRUE)), 
    by = .(exp, variable, lev, fcst_exp)] %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico", value.name = "value.est")

media %>% 
  .[, ":="(fcst_exp_label = factor(fcst_exp, labels = c("atop('00 UTC')", "atop('06 UTC')")),
           variable_labels = factor(variable, labels = c("Temperatura~(K)", 
                                                         "atop('Temperatura de', 
                                                         'punto de rocío (K)')", 
                                                         "Viento~U~(m~s^{-1})", "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(lev/1000, value.est)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = estadistico)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_flip(xlim = c(0, 15)) +
  facet_grid(fcst_exp_label ~ variable_labels, scales = "free_x", 
             labeller = label_parsed) +
  tagger::tag_facets(position = list(x = 0.05, y = 0.95)) +
  labs(y = "Bias/RMSE", x = "Altura (Km)", color = NULL, linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

La Figura \@ref(fig:soudings-all) muestra el RMSE y BIAS calculado comparando con los radiosondeos de RELAMPAGO sobre los miembros del ensamble que utilizan cada una de las parametrizaciones de convección. Nuevamente, se muestran las dos inicializaciones en conjunto ya ambos pronósticos presentan tendencias muy similares. Si bien el comportamiento de las parametrizaciones de convección no es tan honomegeo como si sucedía con las de capa límite, es posible identificar algunos patrones. La parametrización BMJ tiene un RMSE menor tanto para la temperatura como para la temperatura de punto de rocio mientras que la parametrización con mejor RMSE es KF. 

(ref:soudings-all) RMSE y BIAS calculados comparando los pronósticos con sondeos de RELAMPAGO y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de convección BMJ (círculo), GF (triángulo) e KF (cuadrado) para todos los pronósticos en conjunto. 

```{r soudings-all, fig.cap="(ref:soudings-all)", fig.align="center", fig.width=7, fig.height=4}

miembros <- read_rds(here("data/derived_data/soundings/sondeos_agregados_fcst.rds")) %>% 
  .[, mem := formatC(mem, width = 3, flag = "0")] %>% 
  fisica[., on = "mem"] %>% 
  separate(fisica, into = c("cumulus", "pbl")) %>% 
  setDT() %>% 
  .[, BIAS := -BIAS]

cum <- miembros[, .(RMSE = mean(RMSE),
                    BIAS = mean(BIAS),
                    tipo = "cumulus"), 
                by = .(exp, fcst_exp, cumulus, lev, variable)] %>% 
  setnames(c("cumulus", "variable"), c("param", "var"))

vline <- data.frame(variable_label = factor("BIAS"),
                    var_label = factor(c("t", "q", "v"), 
                                       labels = c("Temperatura~(K)",
                                              "atop('Temperatura', 'de punto de rocío (K)')",
                                              "Viento~V~(m~s^{-1})")),
                    value =  0)
cum %>% 
  .[, .(RMSE = mean(RMSE, na.rm = TRUE),
        BIAS = mean(BIAS, na.rm = TRUE)), 
    by = .(var, exp, param, tipo)] %>% 
  .[var != "u"] %>% 
  melt(id.vars = c("exp", "param", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  .[, ":="(variable_label = factor(variable),
           var_label = factor(var, labels = c("Temperatura~(K)",
                                              "atop('Temperatura', 'de punto de rocío (K)')",
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(value, exp)) +
  geom_vline(data = vline, aes(xintercept = value), color = "darkgrey") +
  geom_point(aes(color = exp, shape = param),
             size = 3) +
  scale_color_manual(guide = NULL, values = colores_exp, 
                     labels = c(E2 = "CONV", E5 = "AUT", 
                                E6 = "SATWND", E9 = "RAD")) +
  scale_shape_manual(values = c(19, 17, 15, 3, 0, 8)) +
  scale_y_discrete(labels = c(E2 = "CONV", E5 = "AUT", 
                              E6 = "SATWND", E9 = "RAD")) +
  facet_grid(var_label ~ variable_label, scales = "free", labeller = label_parsed) +
  labs(y = NULL, x = NULL, shape = NULL) +
  tagger::tag_facets(position = list(x = 0.03, y = 0.95)) +
  theme_minimal(base_size = 9) +
  theme(aspect.ratio = 1/2,
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```

Si analizamos los perfiles verticales de RMSE y BIAS para cada parametrización calculados solo sobre los pronósticos RAD (Figura \@ref(fig:souding-rad)), podemos ver que BMJ es la parametrización que mejor representa la humedad en niveles medios pero KF representa mejor la mayoría de las variables en niveles bajos. 

Si bien no es posible elegir solo una parametrización de convección que mejor represente todas las variables, es interesante observar la buena performance de BMJ al representar estas variables. Sin embargo, @dillon2021, utilizando una configuración del ensamble multifísica similar a este trabajo, encontraron que esta parametrización era la que peor representaba la precipitación cuantificada utilizando el FSS. Un análisis similar sobre los experimentos discutidos en este capítulo mostraron la misma tendencia encontrada por @dillon2021, por ejemplo la Figura \@ref(fig:fss-bmj) muestra el FSS calculado sobre el ensamble completo de RAD y los miebros que usan o no esta parametrización. Teniendo en cuenta este resultado y ante la poca variabilidad en los valores de los errores asociados a temperatura, humedad y viento, es posible que el reemplazo de BMJ por otra parametrización de convección de mejores resultados en términos de la representación de la precipitación sin producir mayor impacto en la temperatura, humedad y viento.

(ref:souding-rad) RMSE y BIAS calculados comparando los pronósticos con observaciones de sondeos de RELAMPAGO y promediados sobre los miembros del ensamble que utilizan las parametrizaciones de conveccón BMJ (línea llena), GF (línea a rayas) e KF (línea punteada) para todos los pronósticos en conjunto. 

```{r souding-rad, fig.cap="(ref:souding-rad)", fig.width=6, fig.height=4, fig.align="center"}
cum %>% 
  .[exp == "E9" & fcst_exp == 2018112200] %>% 
  melt(measure.vars = c("RMSE", "BIAS")) %>% 
  .[, ":="(variable_label = factor(variable),
           var_label = factor(var, labels = c("Temperatura~(K)", 
                                              "atop('Temperatura de', 'punto de rocío (K)')", 
                                              "Viento~U~(m~s^{-1})", 
                                              "Viento~V~(m~s^{-1})")))] %>% 
  ggplot(aes(lev/1000, value)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = param, group = interaction(exp, param))) +
  scale_linetype_manual(values = c(1, 2, 3)) +
  scale_color_manual(values = colores_exp[4], labels = c(E9 = "RAD")) +
  coord_flip(xlim = c(0, 15)) +
  facet_grid(variable_label ~ var_label, scales = "free", labeller = label_parsed) +
  labs(y = NULL, x = NULL, linetype = NULL, color = NULL) +
  tagger::tag_facets(position = list(x = 0.03, y = 0.95)) +
  theme_minimal() +
  theme(aspect.ratio = 1,
        legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))
```

(ref:fss-bmj) FSS calculado sobre la precipitación acumulada a 1 hora en una ventana móvil de 6 horas para el umbral de 25 mm y 100 km de escala sobre el pronóstico RAD inicializado a las 00 UTC. La línea roja (RAD) corresponde al ensamble completo, la línea turquesa (BMJ) se calcula sobre los miembros del ensamble que usan la parametrización de convección BMJ y la línea violeta (noBMJ) se calcula sobre los miembros del ensamble que no utilizan BMJ.


```{r fss-bmj, fig.cap="(ref:fss-bmj)", fig.width=4, fig.height=3}

fss <- fread(here("data/derived_data/FSS/fss_6h_fcst_ens_2018112200_E9_ens.csv")) %>% 
    .[, date := as_datetime(date)] %>% 
    .[, ini_date := ymd_h(2018112200)] 

noBMJ <- fread("data/derived_data/FSS/fss_6h_fcst_ens_2018112200_E9_ens_noBMJ.csv") %>% 
  .[, ":="(exp = "noBMJ",
           ini_date = ymd_h(2018112200))]

BMJ <- fread("data/derived_data/FSS/fss_6h_fcst_ens_2018112200_E9_ens_BMJ.csv") %>% 
  .[, ":="(exp = "BMJ",
           ini_date = ymd_h(2018112200))]

rbind(fss, noBMJ, BMJ) %>% 
  .[q %in% c(25) & w %in% c(11)] %>% 
  .[, ":="(q_label = factor(q, labels = c("25~mm~h^{-1}")),
           w_label = factor(w, labels = c("100~km")),
           exp = factor(exp, levels = c("E9", "BMJ", "noBMJ"), 
                        labels = c(E9 = "RAD", BMJ = "BMJ", noBMJ = "noBMJ")))] %>% 
  ggplot(aes(date, fss)) +
  # geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp)) +
  scale_color_manual(values = c("#CC3311", "darkcyan", "magenta4")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  facet_grid(w_label ~ q_label, labeller = label_parsed) +
  labs(color = NULL, x = NULL, y = "FSS", linetype = NULL) +
  theme_minimal(base_size = 9) +
  theme(legend.position = "bottom",
        panel.background = element_rect(fill = "#fbfbfb", color = NA))

```


## Conclusiones
