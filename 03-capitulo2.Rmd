# Impacto de la asimilación de observaciones convencionales, de estaciones automáticas, vientos derivados de satélite y radianzas de satelites polares en pronósticos a corto plazo 


## Metodología

### Configuracion de los experimentos

## Resultados

### Impacto de las observaciones en el pronostico

Al comparar los pronósticos con ERA5, en promedio la temperatura en niveles altos es menor a lo esperado pero no se observan diferencias entre los experimentos o entre las 2 inicializaciones de los pronósticos. Esto sugiere que las condiciones iniciales no afectan particularmente esta variable en niveles altos. En niveles bajos se observa la misma tendencia que en los análisis los pronísticos inicializados a partir de AWS y SATWND muestran un bias cálido mucho menor que CONV gracias a la asimilación de observaciones de EMA. En RAD el bias vuelve a aumentar ligeramente. En niveles bajos si se ven mejoras para la inicialización de las 06 UTC, indicando que las observaciones asimiladas entre las 00 y las 06 UTC tienen un impacto positivo. 

Las comparaciones para la humedad específica muestran nuevamente el bias seco presente en los análisis con una mejora notoria en los pronósticos inicializados a partir de AWS y SATWND y RAD. La inicialización de las 06 UTC no parece ser muy distinta a la primera. 

La mayor diferencia en el viento meridional se observa en niveles altos y está asociado al pediodo de mayor actividad convectiva sobre el norte del dominio. En particular SATWND es el pronóstico que mejor representa el viento meridional, particularmente en el pronóstico inicializado a las 06 UTC. Algo similar se observa en la diferencia para el viento zonal.


**¿Cómo es el campo de viento en esos niveles? y ¿cómo influye en el desarrollo de la convección?**


(ref:era5-fcst-cap) Difference between the forecast ensemble mean experiments and ERA5 for the spatially averaged vertical profiles of air temperature (K, a--d), specific humidity ($g\ Kg^{-1}$, e--h) and meridional wind ($m\ s^{-1}$, i--l) calculated over the inner domain (red box in Figure \@ref(fig:dominio)a) for each analysis cycle.

```{r era5-fcst, fig.cap="(ref:era5-fcst-cap)", fig.align="center", fig.pos="ht"}
# fig.width=7.2, fig.height=6, 
files <- Sys.glob(here("~/datosmunin3/EXP/derived_data/perfiles_fcst_E[2569]_201811220*.csv"))

perfiles <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "perfiles_{run}_{exp}_{ini_date}.csv")
  fread(f) %>% 
    .[, exp := mata_exp[[1]][["exp"]]] %>% 
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 
# .[, date := as_datetime(date)] %>% 
# .[date %between% c(as_datetime("2018-11-20 18:00:00"),
#                    as_datetime("2018-11-23 12:00:00"))]


era <- fread(here("data/derived_data/reanalysis/perfiles_ana_era5.csv"))

perfiles %>%
  .[variable == "T"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = fcst - era, fill = stat(level)),
                    breaks = seq(-4, 3, 0.5)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 3, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left",
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Pressure (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181122000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  labs(fill = "Temperature (K)",
       x = NULL,
       y = "Pressure (hPa)") +
  # tag_facets(position = list(x = 0.1, y = 0.95)) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "QVAPOR"] %>%
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)),
                    breaks = seq(-0.004, 0.0015, 0.0005)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-0.004, 0.0015, 0.0005)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Pressure (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  labs(fill = latex2exp::TeX("Specific \nhumidity ($g$ $Kg^{-1}$)"),
       x = NULL,
       y = "Pressure (hPa)") +
  # tag_facets(position = list(x = 0.1, y = 0.95), tag_pool = c("e", "f", "g", "h")) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "V"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)), 
                    breaks = seq(-4, 11, 1)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 11, 1)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Pressure (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  labs(fill = latex2exp::TeX("V ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Pressure (hPa)") +
  # tag_facets(position = list(x = 0.1, y = 0.95), tag_pool = c("i", "j", "k", "l")) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

perfiles %>%
  .[variable == "U"] %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = bias, fill = stat(level)), 
                    breaks = seq(-4, 4, 0.5)) +
  geom_contour2(aes(z = bias), color = "white", size = 0.1,
                breaks = seq(-4, 4, 0.5)) +
  scale_fill_divergent_discretised(guide = guide_colorsteps(barwidth = 25,
                                                            barheight = 0.3,
                                                            title.position = "left", 
                                                            title.vjust = 1,
                                                            frame.colour = "black")) +
  scale_y_level(name = "Pressure (hPa)", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_date(ini = 20181121000000, break_bin = "12 hours") +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "AWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  labs(fill = latex2exp::TeX("U ($m$ $s^{-1}$)"),
       x = NULL,
       y = "Pressure (hPa)") +
  tag_facets(position = list(x = 0.1, y = 0.95), tag_pool = c("i", "j", "k", "l")) +
  theme_minimal(base_size = 8) +
  theme(legend.position = "bottom",
        tagger.panel.tag.text = element_text(size = 8),
        plot.margin = margin(0, 0, 0, 0, "cm"),
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 

# plot_layout(ncol = 1, heights = c(1, 1, 1)) 
```

### Verificacion de los pronósticos de precipitación

Para cuantificar la habilidad de los pronósticos para predecir la precipitación se calculó el FSS para los pronósticos por ensambles en ventanas móviles de 6 horas para los mismos umbrales y escalas espaciales usados para la precipitación acumulada horaria del first guess (Figura \@ref(fig:fssfcst)). Los pronósticos de CONV generan valores muy bajos de FSS en comparación con los experimentos que incluyen otras fuentes de observaciones. AWS, SATWND y RAD muestran mejoras en los valores de FSS, especialmente para el umbral más alto (Figura \@ref(fig:fssfcst)b, d). Además, la inicialización de las 06 UTC obtiene mejores resultados para AWS, SATWND y RAD que el pronóstico inicializado a las 00 UTC, lo que pone de relieve el impacto positivo de las observaciones asimiladas entre las 00 y las 06 UTC. 

Las observaciones de viento derivadas de satélite muestran un impacto claramente positivo en el pronóstico, a diferencia de lo que se observó al comparar el pronóstico de 1 hora con observaciones independientes en términos de precipitación. Por el contrario, las radiancias tuvieron un impacto entre neutro y ligeramente negativo en el pronóstico, a diferencia de lo que se observó al comparar el pronóstico de 1 hora con las estimaciones del IMERG. **El motivo por el que los pronósticos inicializados a partir de RAD se degradan con el tiempo debe estudiarse más a fondo.** Sin embargo, es posible que la asimilación de observaciones asociadas a canales afectados por la superficie esté contribuyendo a la degradación de la PBL en el análisis y, posteriormente, en los pronósticos. @lim2014 observó un impacto limitado al asimilar las observaciones de AIRS y atribuye este resultado al uso de canales superficiales en los que las incertidumbres asociadas a la emisividad son grandes. 


(ref:fssfcst) FSS calculated over a 6-hour moving window for 1 mm (a and c) and 25 mm (b and d) thresholds, on 10 km (a and b) and 100 km (c and d) scales, for the forecasts initialized from CONV (blue line), AWS (light blue line), SATWND (orange line), and RAD (red line) experiments at 00 UTC (solid line) and 06 UTC (dashed line), Nov 22.

```{r fssfcst, fig.cap="(ref:fssfcst)"}
files <- Sys.glob("/home/paola.corrales/datosmunin3/EXP/derived_data/fss_6h_fcst_ens_*_E[2,5,6,8,9]_ens.csv")

fss <- purrr::map(files, function(f) {
  
  meta <- unglue(basename(f), "fss_6h_fcst_ens_{ini_date}_{exp}_ens.csv")
  
  fread(f) %>% 
    .[, date := as_datetime(date)] %>% 
    .[, ini_date := ymd_h(meta[[1]][["ini_date"]])]
}) %>% 
  rbindlist()

fss %>% 
  .[q %in% c(1, 25) & w %in% c(1, 11)] %>% 
  ggplot(aes(date, fss)) +
  geom_hline(yintercept = 1, color = "darkgray") +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  # geom_point(aes(color = exp)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT",
                                                      E6 = "SATWND", E9 = "RAD")) +
  scale_linetype_manual(values = c(1, 2), labels = c("2018-11-22 00:00:00" = "OO UTC", 
                                                     "2018-11-22 06:00:00" = "06 UTC")) +
  scale_date(20181122000000, 20181123000000, "12 hours") +
  facet_grid(w~q, labeller = labeller(q = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm", "50" = "50 mm"),
                                      w = c("1" = "10 km", "5" = "50 km", 
                                            "11" = "100 km", 
                                            "51" = "500 km", "101" = "1000 km"))) +
  labs(color = NULL, x = NULL, linetype = NULL) +
  theme_minimal()
```

El porcentaje de área cubierta por precipitación mayor a determinados umbrales muestra una importante subestimación de la precipitación media. El área sombreada que muestra el área máxima calculada sobre todo el ensamble se acerca un poco más a lo observado pero en general y sobre todo para umbrales de pp bajos, se adelanta en el tiempo. Los pronósticos inicializados a partir de CONV subestiman el área cubierta por precipitación durante el periodo más activio y luego la sobreestima durante el 23 de noviembre. 



```{r}

imerg <- read_rds("/home/paola.corrales/datosmunin3/EXP/derived_data/IMERG_1h.rds")

q <- c(1, 5, 10, 25, 50)
lon_band = c(-66.5, -61.5)
lat_band = c(-35.5, -29)
imerg <- purrr::map(q, function(f){
  
  imerg %>%
    .[, c("lon", "lat") := wrf_project(x, y, inverse = TRUE, round = FALSE)] %>% 
    .[lon %between% lon_band & lat %between% lat_band] %>%
    .[, .(area = sum(pp_acum > f)/.N), by = .(end_date)] %>%
    .[, umbral := f] %>%
    .[]
}) %>%
  rbindlist()


files <- Sys.glob("/home/paola.corrales/datosmunin3/EXP/derived_data/ppacum/E[2569]_fcst_*_area_acum_1h.rds")

pp_area <- purrr::map(files, function(f) {
  
  meta <- unglue(f, "/home/paola.corrales/datosmunin3/EXP/derived_data/ppacum/{exp}_fcst_{ini_date}_area_acum_1h.rds")
  
  readRDS(f) %>% 
    .[, ":="(ini_date = ymd_h(meta[[1]][["ini_date"]]))]
  
}) %>% rbindlist()

pp_area %>% 
  .[umbral %in% c(1, 5, 10) ] %>%
  .[, .(mean_area = mean(area),
        max_area = max(area),
        min_area = min(area)), by = .(umbral, date, exp, ini_date)] %>% 
  .[, ini_date := factor(ini_date)] %>% 
  ggplot(aes(date, mean_area)) +
  geom_line(data = imerg[umbral %in% c(1, 5, 10)], 
            aes(end_date, area, color = "OBS"),
            linetype = 1) +
  geom_line(aes(color = exp, linetype = factor(ini_date))) +
  geom_ribbon(aes(ymin = min_area, ymax = max_area, fill = exp, group = interaction(exp, ini_date)), alpha = .1) +
  scale_color_manual(values = c(OBS = "grey20", colores_exp),
                     labels =  c(E2 = "CONV", E5 = "ASWS", E6 = "SATWND",
                                 E9 = "RAD", OBS = "OBS")) +
  scale_fill_manual(values = c(OBS = "grey20", colores_exp),
                    guide = NULL,
                    labels = c(E2 = "CONV", E5 = "ASWS", E6 = "SATWND",
                               E9 = "RAD", OBS = "OBS")) +
  scale_y_continuous(label = scales::percent_format()) +
  scale_date(20181122000000, 20181123000000, "12 hours", limits = c(ymd_h(2018112200), ymd_h(2018112312))) +
  facet_grid(ini_date~umbral, scales = "free_y", 
             labeller = labeller(umbral = c("1" = "1 mm", "5" = "5 mm", 
                                            "10" = "10 mm", "25" = "25 mm"))) +
  labs(y = "Areal coverage", x = "Date", 
       fill = NULL, color = NULL, linetype = "FCST init") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

00 UTC
Los pronósticos sobreestiman la ocurrencia de precipitación para los percentiles más bajos (asociados a menor precipitación). Para humbrales más altos/percentiles mayores los pronósticos subestiman la ocurrencia de precipitación, esto es coherente con lo que se ve con el FSS. Como la pendiente es casi siempre positiva, los pronósticos son "confiables"

06 UTC
Subestiman la ocurrencia de precipitación para probabilidades bajas y la sobreestiman para probabilidades altas. Cuando los pronósticos indican una probabilidad de ocurrencia muy alta, la frecuencia observada es muy baja por lo que el pronóstico deja de ser confiable. 


```{r eval=FALSE, include=FALSE}

cut2 <- function (x, breaks) 
{
  # labels <- na.omit((breaks + data.table::shift(breaks, -1))/2)
  cuts <- cut(x, breaks = breaks, labels = breaks[-1], include.lowest = TRUE)
  as.numeric(as.character(cuts))
}

files <- Sys.glob(here("~/datosmunin3/EXP/derived_data/ppacum/E[2,5,6,9]_fcst_*_quant_acum_3h.rds"))

pp_wrf <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "{exp}_{run}_{ini_date}_quant_acum_3h.rds")
  read_rds(f) %>% 
    # .[, exp := mata_exp[[1]][["exp"]]] %>% 
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 


pp_wrf[, prop_interval := cut_width(prop, 0.1, boundary = 0)] %>% 
  .[, prop_interval2 := cut2(prop, breaks = seq(0, 1, 0.2))]

pp_imerg <- read_rds("~/datosmunin3/EXP/derived_data/IMERG_3h.rds")

prop <- pp_imerg[pp_wrf, on = c("x", "y", "end_date" = "date")] %>% 
  .[, obs_bin := as.numeric(pp_acum >= umbral)] 

prop %>% 
  .[end_date %between% c(ymd_hms(20181122000000), ymd_hms(20181123120000)) & ini_date == "2018112200"] %>%
  .[, .(freq_obs = sum(obs_bin)/.N), by = .(exp, ini_date, umbral, prop_interval2)] %>% 
  .[, percentil := paste0("Percentil ", umbral)] %>% 
  ggplot(aes(prop_interval2, freq_obs)) +
  geom_abline(slope = 1, intercept = 0, color = "darkgrey") +
  geom_point(aes(color = exp)) +
  geom_line(aes(color = exp)) +
  
  scale_x_continuous(breaks = seq(0, 1, 0.1)) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT",
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~ percentil) +
  labs(color = NULL, x = "Probabilidad pronosticada", y = "Frecuencia relativa observada") +
  theme_minimal()

# a <- prop[end_date %between% c(ymd_hms(20181122060000), ymd_hms(201811220120000)) & ini_date == "2018112206" & umbral == umbral[1] & exp == "E9"] %>%
#   with(., SpecsVerification::ReliabilityDiagram(prop, obs_bin, bins = 10, plot = TRUE, nboot = 1))
```




```{r}
quantiles <- fread("~/datosmunin3/EXP/derived_data/quantiles_fcst_3h.csv") %>% 
  .[, value := round(value, 2)] %>% 
  dcast(exp + ini_date ~ quantile) %>% 
  .[, ":="(exp = fcase(exp == "E2", "CONV",
                       exp == "E5", "AWS",
                       exp == "E6", "SATWND",
                       exp == "E9", "RAD"),
           ini_date = fifelse(ini_date == ymd_hms(20181122000000), "00 UTC", "06 UTC"))] %>% 
  arrange(ini_date)

quantiles %>% 
  knitr::kable() %>% 
  kableExtra::kable_styling() %>% 
  kableExtra::collapse_rows(columns = 2) 


```


La probabilidad de pp mayor a 10 mm en un periodo de 30 hs, muestra que la pp se genera más al norter y al oeste de lo observado. Los pronósticos tardan en generar precipitación abundante al comienzo.

Entre las 2 inicializaciones se ve una clara difirencia, la probabilidad de pricipitación para los disitntos umbrales en 06 UTC es mayor y si bien tiene un corrimiento al oeste en la región norte (es decir cuando la convección está mas concentrada en el norte del pais) ocupa una región similar a la pp observada. 

SATWND tiene probabilidades mayores a los otros pronósticos. 

```{r}
files <- Sys.glob(here("~/datosmunin3/EXP/derived_data/ppacum/E[2,5,6,9]_fcst_*_prop_acum_30h.rds"))

pp_wrf <- purrr::map(files, function(f) {
  mata_exp <- unglue(basename(f), "{exp}_{run}_{ini_date}_prop_acum_30h.rds")
  read_rds(f) %>% 
    .[, exp := mata_exp[[1]][["exp"]]] %>%
    .[, ini_date := mata_exp[[1]][["ini_date"]]]
  
}) %>% 
  rbindlist() 

pp_imerg <- read_rds("~/datosmunin3/EXP/derived_data/IMERG_1h.rds")

pp_imerg <- rbind(pp_imerg[end_date %between% c(ymd_hms(20181122010000), ymd_hms(20181123060000)),
                           .(pp_acum = sum(pp_acum),
                             ini_date = "2018112200"), by = .(x, y)],
                  
                  pp_imerg[end_date %between% c(ymd_hms(20181122070000), ymd_hms(20181123120000)),
                           .(pp_acum = sum(pp_acum),
                             ini_date = "2018112206"), by = .(x, y)] 
)

colors_smooth_rainbow <- c("#E8ECFB", "#B997C7", "#824D99", "#4E78C4", "#57A2AC", "#7EB875", "#D0B541",
                           "#E67F33", "#CE2220", "#521A13")

pp_wrf[umbral == 10 & prop > 0.09] %>% 
  .[, prop := prop + abs(rnorm(.N, sd = 0.0000000001))] %>%
  .[, prop := scales::rescale(prop, to = c(0, 1))] %>% 
  ggplot(aes(x, y)) +
  # geom_raster(aes(fill = prop)) +
  geom_contour_fill(aes(z = prop, fill = ..level..),
                    proj = norargentina_lambert) +
  scale_fill_manual(values = colors_smooth_rainbow) +
  geom_contour2(data = pp_imerg, aes(z = pp_acum), color = "black",
                breaks = 10,
                proj = norargentina_lambert) +
  geom_mapa() +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "ASWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  theme_minimal()

pp_wrf[umbral == 50 & prop > 0.09] %>% 
  .[, prop := prop + abs(rnorm(.N, sd = 0.0000000001))] %>%
  .[, prop := scales::rescale(prop, to = c(0, 1))] %>% 
  ggplot(aes(x, y)) +
  # geom_raster(aes(fill = prop)) +
  geom_contour_fill(aes(z = prop, fill = ..level..),
                    proj = norargentina_lambert) +
  scale_fill_manual(values = colors_smooth_rainbow) +
  geom_contour2(data = pp_imerg, aes(z = pp_acum), color = "black",
                breaks = 50,
                proj = norargentina_lambert) +
  geom_mapa() +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "ASWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  theme_minimal()


pp_wrf[umbral == 100 & prop > 0.09] %>% 
  .[, prop := prop + abs(rnorm(.N, sd = 0.0000000001))] %>%
  .[, prop := scales::rescale(prop, to = c(0, 1))] %>% 
  ggplot(aes(x, y)) +
  # geom_raster(aes(fill = prop)) +
  geom_contour_fill(aes(z = prop, fill = ..level..),
                    proj = norargentina_lambert) +
  scale_fill_manual(values = colors_smooth_rainbow) +
  geom_contour2(data = pp_imerg, aes(z = pp_acum), color = "black",
                breaks = 100,
                proj = norargentina_lambert) +
  geom_mapa() +
  facet_grid(ini_date ~ exp, labeller = labeller(exp = c(E2 = "CONV", E5 = "ASWS", 
                                                         E6 = "SATWND", E9 = "RAD"))) +
  theme_minimal()

pp_imerg %>% 
  ggplot(aes(x, y)) +
  geom_contour_fill(aes(z = pp_acum, fill = ..level..),
                    proj = norargentina_lambert) +
  facet_wrap(~ini_date) +
  geom_mapa()



```
### Análisis y verificación por parametrizaciones

Comparación con las observaciones de EMA durante el periodo. 

Humedad y temperatura: la diferencia principal entre las inicializaciones está en el BIAS, el error de los pronósticos tiene una componente sistemática importante. 06 UTC arranca mejor en términos de bias, no se ve mucha mejora en el RMSE. CONV mantiene un bias y rmse mayor respecto de los otros experimentos. El resto mantiene la tendencia vista en los análisis y comparación con ERA5

**¿Se ve por cuanto tiempo perdura la mejora?**

Para el viento zonal, no se ve muchas diferencias entre las inicializaciones o los experimentos al comienzo. Aunque hacia la mitad de 22 de noviembre se ve que 06 UTC tiene mayor bias y rmse. 

Viento meridional, 06 UTC arranca mejor respecto del RMSE y eso se mantiene por al menos 6 horas.


```{r}
fisica <- data.table(mem = as.character(formatC(1:60, flag = "0", width = 3)),
                     fisica = rep(c("KF-YSU", 
                                    "BMJ-YSU",
                                    "GF-YSU",
                                    "KF-MYJ",
                                    "BMJ-MYJ",
                                    "GF-MYJ",
                                    "KF-MYNN2",
                                    "BMJ-MYNN2",
                                    "GF-MYNN2"), length.out = 60)) %>% setDT()

derived_data <- "/home/paola.corrales/datosmunin3/EXP/derived_data/"
media <- rbind(read_rds(paste0(derived_data, "/interp_obs/interp_obs_2018112200_mean_new.rds")),
               read_rds(paste0(derived_data, "/interp_obs/interp_obs_2018112206_mean_new.rds"))) %>% 
  .[, ":="(RMSE = fifelse(var == "q", RMSE*1000, RMSE),
           BIAS = fifelse(var == "q", BIAS*1000, BIAS))] %>% 
  .[, BIAS := -BIAS]

media %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico") %>% 
  # .[estadistico == "RMSE"] %>% 
  ggplot(aes(date, value)) +
  geom_hline(yintercept = 0, color = "darkgrey") +
  geom_line(aes(color = exp, linetype = fcst_exp)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E9 = "RAD")) +
  scale_date() +
  labs(x = NULL, y = NULL, linetype = NULL, color = NULL) +
  facet_grid(estadistico ~ var, scales = "free_y", 
             labeller = labeller(var = c("q" = "Humedad específica (g/kg)",
                                         "t" = "Temperatura (K)",
                                         "u" = "Viento zonal (m/s)",
                                         "v" = "Viento meridional (m/s)"))) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
miembros <- rbind(read_rds(paste0(derived_data, "/interp_obs/interp_obs_2018112200_mem_new.rds")),
                  read_rds(paste0(derived_data, "/interp_obs/interp_obs_2018112206_mem_new.rds"))) %>% 
    .[, ":="(RMSE = fifelse(var == "q", RMSE*1000, RMSE),
           BIAS = fifelse(var == "q", BIAS*1000, BIAS))] %>% 
  .[, BIAS := -BIAS]

pbl <- fisica[miembros, on = .NATURAL] %>% 
  separate(fisica, into = c("cumulus", "pbl")) %>% 
  .[, .(BIAS = mean(BIAS),
        RMSE = mean(RMSE)), by = .(exp, fcst_exp, pbl, var, date)] %>% 
   setnames("pbl", "param") %>% 
  .[, tipo := "pbl"]

pbl %>% 
  .[, .(RMSE = mean(RMSE, na.rm = TRUE),
        BIAS = mean(BIAS, na.rm = TRUE)), 
    by = .(var, exp, param, tipo)] %>% 
  .[var != "u"] %>% 
  melt(id.vars = c("exp", "param", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  ggplot(aes(value, exp)) +
  geom_point(aes(color = exp, shape = param),
             size = 3) +
  scale_color_manual(guide = NULL, values = colores_exp, 
                      labels = c(E2 = "CONV", E5 = "AUT", 
                                 E6 = "SATWND", E9 = "RAD")) +
  scale_shape_manual(values = c(19, 17, 15, 3, 0, 8)) +
  scale_y_discrete(labels = c(E2 = "CONV", E5 = "AUT", 
                                 E6 = "SATWND", E9 = "RAD")) +
  facet_grid(var ~ variable, scales = "free",   labeller = labeller(var = c("q" = "Humedad\n específica (g/kg)",
                                         "t" = "Temperatura (K)",
                                         "u" = "Viento zonal (m/s)",
                                         "v" = "Viento\n meridional (m/s)"))) +
  labs(y = NULL, x = NULL, shape = NULL) +
  theme_minimal() +
  theme(aspect.ratio = 1/2,
        panel.background = element_rect(fill = "grey98",
                                        color = "grey98"))

```


```{r}
pbl %>% 
  melt(id.vars = c("exp", "param", "fcst_exp", "date", "var"), measure.vars = c("RMSE", "BIAS")) %>% 
  .[exp == "E9" & fcst_exp == "2018112200"] %>% 
  ggplot(aes(date, value)) +
  # geom_hline(yintercept = 0, color = "darkgrey") +
  geom_line(aes(color = exp, linetype = param)) +
  scale_color_manual(values = colores_exp[4], labels = c(E9 = "RAD")) +
  # geom_hline(yintercept = 0, color = "grey30") +
  scale_linetype_manual(values = c(1, 2, 3)) +
  scale_date() +
  labs(x = NULL, y = NULL, linetype = NULL, color = NULL) +
  facet_grid(variable ~ var, scales = "free_y", labeller = labeller(var = c("q" = "Humedad\n específica (g/kg)",
                                         "t" = "Temperatura (K)",
                                         "u" = "Viento zonal (m/s)",
                                         "v" = "Viento\n meridional (m/s)"))) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
media <- read_rds("/home/paola.corrales/datosmunin3/EXP/derived_data/sondeos_media.rds") %>% 
  .[, .(RMSE = sqrt(mean((fcst_value - value)^2, na.rm = TRUE)), 
        BIAS = mean(fcst_value - value, na.rm = TRUE)), 
    by = .(exp, variable, lev, fcst_exp)] %>% 
  melt(measure.vars = c("RMSE", "BIAS"), variable.name = "estadistico", value.name = "value.est")

media %>% 
  ggplot(aes(lev/1000, value.est)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = estadistico)) +
  scale_color_manual(values = colores_exp, labels = c(E2 = "CONV", E5 = "AUT", 
                                                      E6 = "SATWND", E9 = "RAD")) +
  coord_flip(xlim = c(0, 15)) +
  facet_grid(fcst_exp ~variable, scales = "free_x", 
             labeller = labeller(variable = c("t" = "Temperature",
                                              "td" = "Dew point\ntemperature",
                                              "u" = "U wind",
                                              "v" = "V wind"))) +
  labs(y = NULL, x = "Height (Km)", color = NULL, linetype = NULL) +
  theme_minimal()

```

```{r}
miembros <- read_rds("/home/paola.corrales/datosmunin3/EXP/derived_data/sondeos_agregados.rds") %>% 
  .[, mem := formatC(mem, width = 3, flag = "0")] %>% 
  fisica[., on = "mem"] %>% 
  separate(fisica, into = c("cumulus", "pbl")) %>% 
  setDT() %>% 
  .[, BIAS := -BIAS]

cum <- miembros[, .(RMSE = mean(RMSE),
                    BIAS = mean(BIAS),
                    tipo = "cumulus"), 
                by = .(exp, fcst_exp, cumulus, lev, variable)] %>% 
  setnames("cumulus", "param")

cum %>% 
  .[, .(RMSE = mean(RMSE, na.rm = TRUE),
        BIAS = mean(BIAS, na.rm = TRUE)), 
    by = .(variable, exp, param, tipo)] %>% 
  .[variable != "u"] %>% 
  melt(id.vars = c("exp", "param", "variable"), measure.vars = c("RMSE", "BIAS")) %>% 
  ggplot(aes(value, exp)) +
  # geom_vline(xintercept = 0, color = "grey70") +
  geom_point(aes(color = exp, shape = param),
             size = 3) +
  scale_color_manual(guide = NULL, values = colores_exp, 
                      labels = c(E2 = "CONV", E5 = "AUT", 
                                 E6 = "SATWND", E9 = "RAD")) +
  scale_shape_manual(values = c(19, 17, 15, 3, 0, 8)) +
  scale_y_discrete(labels = c(E2 = "CONV", E5 = "AUT", 
                                 E6 = "SATWND", E9 = "RAD")) +
  facet_grid(variable ~ variable.1, scales = "free", labeller = labeller(variable = c("t" = "Temperature",
                                              "td" = "Dew point\ntemperature",
                                              "u" = "U wind",
                                              "v" = "V wind"))) +
  labs(y = NULL, x = NULL, shape = NULL) +
  theme_minimal() +
  theme(aspect.ratio = 1/2,
        panel.background = element_rect(fill = "grey98",
                                        color = "grey98"))

```


```{r}
cum %>% 
  .[exp == "E9" & fcst_exp == 2018112200] %>% 
  melt(measure.vars = c("RMSE", "BIAS")) %>% 
  ggplot(aes(lev/1000, value)) +
  geom_hline(yintercept = 0, color = "grey30") +
  geom_line(aes(color = exp, linetype = param, group = interaction(exp, param))) +
  scale_linetype_manual(values = c(1, 2, 3)) +
  scale_color_manual(values = colores_exp[4], labels = c(E9 = "RAD")) +
  coord_flip(xlim = c(0, 15)) +
  facet_grid(factor(variable.1) ~ variable, scales = "free_x", 
             labeller = labeller(variable = c("t" = "Temperature",
                                              "td" = "Dew point\ntemperature",
                                              "u" = "U wind",
                                              "v" = "V wind"))) +
  labs(y = NULL, x = "Height (Km)", color = NULL, linetype = NULL) +
  theme_minimal()
```


## Conclusiones
